<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= product.name %> | EaGCart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .description-content img {
        max-width: 100%;
        height: auto;
        border-radius: 0.5rem;
      }
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }
      @keyframes fadeInOut {
        0% {
          opacity: 0;
          transform: translateY(5px) translateX(-50%);
        }
        10% {
          opacity: 1;
          transform: translateY(0) translateX(-50%);
        }
        90% {
          opacity: 1;
          transform: translateY(0) translateX(-50%);
        }
        100% {
          opacity: 0;
          transform: translateY(-5px) translateX(-50%);
        }
      }
      .tooltip-animate {
        animation: fadeInOut 3s forwards;
      }
    </style>
  </head>
  <body class="bg-slate-50 min-h-screen flex flex-col">
    <%- include('../partials/header.ejs') %>

    <!-- [ì‹ ê·œ] í’ˆì ˆ ìƒíƒœ ì²´í¬ ë° ë¦¬ë‹¤ì´ë ‰íŠ¸ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
      // ì„œë²„ ì‚¬ì´ë“œ ë³€ìˆ˜ ê°’ì„ JS ë³€ìˆ˜ë¡œ ê°€ì ¸ì˜´
      const productStatus = "<%= product.status %>";

      if (productStatus === "í’ˆì ˆ") {
        alert("í•´ë‹¹ ìƒí’ˆì€ í˜„ì¬ í’ˆì ˆ ìƒíƒœì…ë‹ˆë‹¤.");
        location.href = "/"; // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
      }
    </script>

    <!-- ë§Œì•½ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì „ í™”ë©´ì´ ì ê¹ ë³´ì´ëŠ” ê²ƒì„ ë°©ì§€í•˜ë ¤ë©´ body ì „ì²´ë¥¼ ìˆ¨ê²¼ë‹¤ê°€ ë³´ì—¬ì£¼ëŠ” ë°©ì‹ì„ ì“¸ ìˆ˜ë„ ìˆì§€ë§Œ, 
         alertê°€ ëœ¨ë©´ ë¸Œë¼ìš°ì € ë Œë”ë§ì´ ë©ˆì¶”ë¯€ë¡œ ì´ ì •ë„ë©´ ì¶©ë¶„í•©ë‹ˆë‹¤. 
         ì•ˆì „í•˜ê²Œ í•˜ë ¤ë©´ ì•„ë˜ main íƒœê·¸ì— style="display: none;"ì„ ì£¼ê³  JSì—ì„œ ìƒíƒœ í™•ì¸ í›„ ë³´ì—¬ì£¼ëŠ” ë°©ë²•ë„ ìˆìŠµë‹ˆë‹¤. -->

    <main class="flex-grow max-w-6xl mx-auto w-full px-6 py-12 space-y-12">
      <!-- ... (ê¸°ì¡´ ìƒì„¸ í˜ì´ì§€ ë‚´ìš© ìœ ì§€) ... -->
      <section class="grid gap-12 lg:grid-cols-2 items-start">
        <!-- [ì™¼ìª½] ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë” -->
        <div
          class="relative w-full aspect-square max-h-[550px] bg-white border border-slate-200 rounded-2xl overflow-hidden group shadow-sm mx-auto"
        >
          <% if (product.gallery && product.gallery.length > 0) { %>
          <img
            id="mainImage"
            src="<%= product.gallery[0] %>"
            alt="<%= product.name %>"
            class="w-full h-full object-contain transition-opacity duration-300 p-4"
          />
          <% if (product.gallery.length > 1) { %>
          <button
            onclick="changeImage(-1)"
            class="absolute left-0 top-0 bottom-0 w-16 flex items-center justify-center bg-transparent hover:bg-black/5 transition text-slate-300 hover:text-slate-500 text-5xl font-light focus:outline-none group-hover:opacity-100 opacity-0 duration-200"
          >
            â€¹
          </button>
          <button
            onclick="changeImage(1)"
            class="absolute right-0 top-0 bottom-0 w-16 flex items-center justify-center bg-transparent hover:bg-black/5 transition text-slate-300 hover:text-slate-500 text-5xl font-light focus:outline-none group-hover:opacity-100 opacity-0 duration-200"
          >
            â€º
          </button>
          <% } %> <% } else { %>
          <div
            class="w-full h-full flex flex-col items-center justify-center text-slate-300 bg-slate-50"
          >
            <span class="text-6xl mb-4">ğŸ“·</span>
            <span class="text-lg font-medium">ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</span>
          </div>
          <% } %>
        </div>

        <!-- [ì˜¤ë¥¸ìª½] ìƒí’ˆ ì •ë³´ ì˜ì—­ -->
        <div
          class="flex flex-col w-full max-w-lg mx-auto lg:mx-0 lg:max-w-none pt-2"
        >
          <!-- í—¤ë” ë° ì°œí•˜ê¸° -->
          <div class="border-b border-slate-100 pb-6 mb-6">
            <div class="flex justify-between items-start mb-3">
              <h1
                class="text-3xl font-bold text-slate-900 leading-tight tracking-tight pr-4"
              >
                <%= product.name %>
              </h1>
              <button
                id="wishBtn"
                onclick="toggleWishlist('<%= product.code %>')"
                class="group p-2 -mr-2 rounded-full hover:bg-rose-50 transition-colors focus:outline-none"
                title="ì°œí•˜ê¸°"
              >
                <% if (product.isWished) { %>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-8 w-8 text-rose-500 transition-colors"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path
                    d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z"
                  />
                </svg>
                <% } else { %>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-8 w-8 text-slate-300 group-hover:text-rose-500 transition-colors"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                  stroke-width="1.5"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
                  />
                </svg>
                <% } %>
              </button>
            </div>
            <div class="space-y-1">
              <% if (product.devices) { %>
              <div class="text-sm text-slate-500 font-medium">
                <%= product.devices %>
              </div>
              <% } %> <% if (product.categories) { %>
              <div class="text-sm text-slate-400">
                <%= product.categories %>
              </div>
              <% } %>
            </div>
          </div>

          <!-- ê°€ê²© ì •ë³´ -->
          <div class="mb-10">
            <% if (product.salePrice) { %>
            <div class="flex items-center gap-2 mb-1">
              <span class="text-slate-400 line-through text-lg"
                ><%= product.price.toLocaleString() %>ì›</span
              >
            </div>
            <% } %>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span
                  class="text-4xl font-extrabold text-slate-900 tracking-tight"
                  ><%= (product.salePrice || product.price).toLocaleString()
                  %>ì›</span
                >
                <% if (product.salePrice) { %><span
                  class="bg-rose-100 text-rose-600 px-3 py-1 rounded-lg font-bold text-xl"
                  >-<%= product.discountRate %>%</span
                ><% } %>
              </div>
              <a
                href="/product/discount-history?id=<%= product.code %>"
                class="text-slate-300 hover:text-slate-500 transition p-2 hover:bg-slate-100 rounded-lg"
                title="ê°€ê²© ë³€ë™ ë‚´ì—­"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-8 w-8"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                  />
                </svg>
              </a>
            </div>
          </div>

          <!-- 3. ì»¨íŠ¸ë¡¤ ì˜ì—­ -->
          <div class="space-y-6">
            <div class="flex items-center">
              <div
                class="flex items-center border border-slate-300 rounded-lg bg-white h-12 overflow-hidden w-32"
              >
                <button
                  onclick="changeDetailQty(-1)"
                  class="w-10 h-full flex items-center justify-center bg-white hover:bg-slate-50 text-slate-500 transition border-r border-slate-200"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M20 12H4"
                    />
                  </svg>
                </button>
                <input
                  type="number"
                  id="quantity"
                  value="1"
                  min="1"
                  readonly
                  class="flex-1 w-full text-center font-bold text-lg text-slate-800 outline-none bg-white h-full"
                />
                <button
                  onclick="changeDetailQty(1)"
                  class="w-10 h-full flex items-center justify-center bg-white hover:bg-slate-50 text-slate-500 transition border-l border-slate-200"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4v16m8-8H4"
                    />
                  </svg>
                </button>
              </div>
            </div>

            <div class="flex flex-col gap-3 relative">
              <div
                id="cartTooltip"
                class="hidden absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-gray-900 text-white text-sm font-medium py-2.5 px-5 rounded-full shadow-2xl flex items-center gap-3 z-50 whitespace-nowrap tooltip-animate"
              >
                <span>âœ… ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤.</span>
                <a
                  href="/cart"
                  class="text-purple-300 hover:text-white font-bold underline transition-colors"
                  >ì´ë™í•˜ê¸°</a
                >
                <div
                  class="absolute bottom-[-6px] left-1/2 -translate-x-1/2 w-3 h-3 bg-gray-900 rotate-45"
                ></div>
              </div>
              <button
                onclick="addToCart()"
                class="w-full py-4 rounded-xl bg-purple-100 text-purple-700 font-bold text-lg hover:bg-purple-200 hover:text-purple-800 transition active:scale-[0.99] duration-150"
              >
                ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
              </button>
              <button
                onclick="buyNow()"
                class="w-full py-4 rounded-xl bg-purple-600 text-white font-bold text-lg hover:bg-purple-700 hover:shadow-lg transition shadow-md shadow-purple-200 active:scale-[0.99] duration-150"
              >
                ë°”ë¡œêµ¬ë§¤
              </button>
            </div>
          </div>
        </div>
      </section>

      <section class="border-t border-slate-200 pt-12">
        <h2
          class="text-2xl font-bold mb-8 text-slate-800 border-b border-slate-200 pb-4 inline-block"
        >
          ìƒí’ˆ ìƒì„¸ ì •ë³´
        </h2>
        <div
          class="bg-white rounded-3xl border border-slate-100 p-8 md:p-12 shadow-sm h-auto description-content leading-relaxed text-slate-700"
        >
          <% if (product.description) { %> <%-
          product.description.replace(/\n/g, '<br />') %> <% } else { %>
          <div
            class="flex flex-col items-center justify-center py-20 text-slate-400"
          >
            <span class="text-4xl mb-4">ğŸ“</span>
            <p>ë“±ë¡ëœ ìƒì„¸ ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
          <% } %>
        </div>
      </section>
      <%- include('../partials/reviews.ejs', { reviews: product.reviews }) %>
    </main>

    <%- include('../partials/footer.ejs') %>

    <script>
      async function changeDetailQty(change) {
        const qtyInput = document.getElementById('quantity');
        let currentQty = parseInt(qtyInput.value);
        let newQty = currentQty + change;
        const productCode = '<%= product.code %>';

        if (newQty < 1) { alert("ìµœì†Œ ìˆ˜ëŸ‰ì€ 1ê°œì…ë‹ˆë‹¤."); return; }

        if (change > 0) {
            try {
                const res = await fetch(`/api/product/stock?id=${productCode}`);
                const data = await res.json();
                if (data.success) {
                    if (newQty > data.stock) { alert('í˜„ì¬ ì¬ê³ ë³´ë‹¤ êµ¬ë§¤í•  ê°œìˆ˜ê°€ ë§ìŠµë‹ˆë‹¤.'); return; }
                } else { alert("ì¬ê³  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
            } catch (e) { console.error(e); alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜"); return; }
        }
        qtyInput.value = newQty;
      }

      async function checkStockAndProceed(action) {
         const qty = document.getElementById('quantity').value;
         const productCode = '<%= product.code %>';
         if (qty < 1) return alert('ìµœì†Œ ìˆ˜ëŸ‰ì€ 1ê°œì…ë‹ˆë‹¤.');
         try {
            const res = await fetch(`/api/product/stock?id=${productCode}`);
            const data = await res.json();
            if (data.success) {
               if (parseInt(qty) > data.stock) { alert('í˜„ì¬ ì¬ê³ ë³´ë‹¤ êµ¬ë§¤í•  ê°œìˆ˜ê°€ ë§ìŠµë‹ˆë‹¤.'); return; }
               if (action === 'cart') addToCartLogic(productCode, qty);
               else if (action === 'buy') location.href = `/checkout?id=${productCode}&qty=${qty}`;
            } else { alert("ì¬ê³  ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
         } catch(e) { console.error(e); alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜"); }
      }

      function buyNow() { checkStockAndProceed('buy'); }
      function addToCart() { checkStockAndProceed('cart'); }

      async function addToCartLogic(productCode, qty) {
        try {
          const res = await fetch('/cart/add', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ productCode, qty }) });
          const data = await res.json();
          if (data.needLogin) { if(confirm("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) location.href = '/login'; return; }
          if (data.success) {
            const tooltip = document.getElementById('cartTooltip');
            tooltip.classList.remove('hidden'); tooltip.classList.add('tooltip-animate');
            setTimeout(() => { tooltip.classList.remove('tooltip-animate'); tooltip.classList.add('hidden'); }, 3000);
          } else { alert(data.message); }
        } catch (e) { console.error(e); alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜"); }
      }

      async function toggleWishlist(productCode) {
        try {
          const res = await fetch('/product/wishlist/toggle', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ productCode }) });
          const data = await res.json();
          if (data.needLogin) { if(confirm("ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) location.href = '/login'; return; }
          if (data.success) {
            const btn = document.getElementById('wishBtn');
            if (data.action === 'added') btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-rose-500 transition-colors" viewBox="0 0 24 24" fill="currentColor"><path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z" /></svg>`;
            else btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-slate-300 group-hover:text-rose-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>`;
          }
        } catch(e) {}
      }

      const gallery = <%- JSON.stringify(product.gallery || []) %>;
      let currentIndex = 0;
      const mainImage = document.getElementById('mainImage');
      function changeImage(direction) {
        if (!gallery || gallery.length <= 1) return;
        currentIndex += direction;
        if (currentIndex >= gallery.length) currentIndex = 0;
        if (currentIndex < 0) currentIndex = gallery.length - 1;
        mainImage.style.opacity = '0.5';
        setTimeout(() => { mainImage.src = gallery[currentIndex]; mainImage.style.opacity = '1'; }, 150);
      }
    </script>
  </body>
</html>
