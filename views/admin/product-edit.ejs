<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>관리자 - 상품 수정 | EaGCart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .dragging {
        opacity: 0.5;
        background-color: #f3f4f6;
        border: 2px dashed #a78bfa;
      }
      .cursor-grab {
        cursor: grab;
      }
      .cursor-grabbing {
        cursor: grabbing;
      }

      /* [수정됨] 숫자 입력창 화살표(Spinner) 숨기기 */
      /* Chrome, Safari, Edge, Opera */
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      /* Firefox */
      input[type="number"] {
        -moz-appearance: textfield;
      }
    </style>
  </head>
  <body class="bg-gray-100 font-sans">
    <div class="flex">
      <%- include('./partials/sidebar.ejs', { active }) %>

      <main class="flex-1 p-8 space-y-6 overflow-y-auto h-screen">
        <div
          class="flex items-center justify-between mb-8 border-b pb-4 border-gray-300"
        >
          <h2 class="text-3xl font-bold text-gray-800">
            상품 수정 (<%= product.PRODUCT_CODE %>)
          </h2>
        </div>

        <section class="bg-white p-8 rounded-lg shadow-md">
          <form
            action="/admin/products/edit/<%= product.PRODUCT_CODE %>"
            method="post"
            enctype="multipart/form-data"
            class="space-y-8"
            id="editForm"
          >
            <!-- 상품 상태 변경 -->
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2"
                >상품 상태</label
              >
              <div class="flex items-center gap-6">
                <label class="inline-flex items-center cursor-pointer">
                  <input type="radio" name="status" value="판매중"
                  class="form-radio text-purple-600 h-5 w-5
                  focus:ring-purple-500" <%= product.STATUS === '판매중' ?
                  'checked' : '' %>>
                  <span class="ml-2 text-gray-700 font-medium">판매중</span>
                </label>
                <label class="inline-flex items-center cursor-pointer">
                  <input type="radio" name="status" value="품절"
                  class="form-radio text-purple-600 h-5 w-5
                  focus:ring-purple-500" <%= product.STATUS === '품절' ?
                  'checked' : '' %>>
                  <span class="ml-2 text-gray-700 font-medium">품절</span>
                </label>
                <label class="inline-flex items-center cursor-pointer">
                  <input type="radio" name="status" value="중지"
                  class="form-radio text-purple-600 h-5 w-5
                  focus:ring-purple-500" <%= product.STATUS === '중지' ?
                  'checked' : '' %>>
                  <span class="ml-2 text-gray-700 font-medium">중지</span>
                </label>
              </div>
            </div>

            <!-- 상품명 -->
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2"
                >상품명 <span class="text-red-500">*</span></label
              >
              <input
                type="text"
                name="name"
                value="<%= product.PRODUCT_NAME %>"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition"
                required
              />
            </div>

            <!-- 태그 설정 -->
            <div class="space-y-6">
              <!-- 기기 태그 -->
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2"
                  >기기 태그</label
                >
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                  <div class="flex flex-wrap gap-3">
                    <% if (options && options.devices) { %> <%
                    options.devices.forEach(device => { %>
                    <label
                      class="inline-flex items-center cursor-pointer hover:bg-gray-100 p-1 rounded transition"
                    >
                      <input type="checkbox" name="devices" value="<%=
                      device.code %>" class="form-checkbox h-5 w-5
                      text-purple-600 rounded border-gray-300
                      focus:ring-purple-500" <%=
                      product.devices.includes(device.code) ? 'checked' : '' %>
                      />
                      <span class="ml-2 text-sm text-gray-700 font-medium"
                        ><%= device.name %></span
                      >
                    </label>
                    <% }) %> <% } %>
                  </div>
                </div>
              </div>

              <!-- 카테고리 태그 -->
              <div>
                <label class="block text-sm font-bold text-gray-700 mb-2"
                  >카테고리 태그</label
                >
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                  <div class="flex flex-wrap gap-3">
                    <% if (options && options.categories) { %> <%
                    options.categories.forEach(cate => { %>
                    <label
                      class="inline-flex items-center cursor-pointer hover:bg-gray-100 p-1 rounded transition"
                    >
                      <input type="checkbox" name="categories" value="<%=
                      cate.code %>" class="form-checkbox h-5 w-5 text-purple-600
                      rounded border-gray-300 focus:ring-purple-500" <%=
                      product.categories.includes(cate.code) ? 'checked' : '' %>
                      />
                      <span class="ml-2 text-sm text-gray-700 font-medium"
                        ><%= cate.name %></span
                      >
                    </label>
                    <% }) %> <% } %>
                  </div>
                </div>
              </div>
            </div>

            <!-- 판매가, 원가, 설명 -->
            <div class="grid gap-8 md:grid-cols-3">
              <div class="md:col-span-1 space-y-6">
                <!-- 판매가 -->
                <div>
                  <label class="block text-sm font-bold text-gray-700 mb-2"
                    >판매가 <span class="text-red-500">*</span></label
                  >
                  <div class="relative">
                    <input
                      type="number"
                      name="price"
                      value="<%= product.SELLING_PRICE %>"
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition"
                      required
                    />
                    <span
                      class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-bold"
                      >원</span
                    >
                  </div>
                </div>
                <!-- 원가 -->
                <div>
                  <label class="block text-sm font-bold text-gray-700 mb-2"
                    >원가</label
                  >
                  <div class="relative">
                    <input
                      type="number"
                      name="originalPrice"
                      value="<%= product.ORIGINAL_PRICE %>"
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition"
                    />
                    <span
                      class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 font-bold"
                      >원</span
                    >
                  </div>
                </div>
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-bold text-gray-700 mb-2"
                  >상품 설명</label
                >
                <textarea
                  name="description"
                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition h-[180px]"
                >
<%= product.PRODUCT_DESCRIPTION || '' %></textarea
                >
              </div>
            </div>

            <!-- 이미지 관리 -->
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2"
                >상품 이미지 (최대 5장 / 드래그하여 순서 변경)</label
              >

              <input type="hidden" name="imageOrder" id="imageOrderInput" />

              <div class="flex flex-col md:flex-row gap-6">
                <!-- 첨부 버튼 -->
                <label
                  class="md:w-1/3 h-48 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-purple-50 hover:border-purple-400 transition group relative"
                >
                  <input
                    type="file"
                    id="fileInput"
                    multiple
                    accept="image/png, image/jpeg"
                    class="hidden"
                  />
                  <svg
                    class="w-10 h-10 text-gray-400 group-hover:text-purple-500 mb-2 transition"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
                    />
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"
                    />
                  </svg>
                  <span
                    class="text-sm font-bold text-gray-600 group-hover:text-purple-600 transition"
                    >이미지 추가</span
                  >
                  <span class="text-xs text-gray-400 mt-1">JPG, PNG</span>
                </label>

                <!-- 파일 목록 -->
                <div
                  class="md:w-2/3 border border-gray-200 rounded-lg p-4 bg-gray-50 h-48 overflow-y-auto"
                >
                  <div id="image-preview-list" class="space-y-2"></div>
                </div>
              </div>
              <input
                type="file"
                name="productImages"
                id="finalFileInput"
                class="hidden"
                multiple
              />
            </div>

            <div class="pt-6 border-t border-gray-100 flex justify-end gap-3">
              <a
                href="/admin/products"
                class="px-6 py-3 rounded-lg border border-gray-300 text-gray-700 font-bold hover:bg-gray-50 transition"
                >취소</a
              >
              <button
                type="submit"
                class="px-8 py-3 rounded-lg bg-purple-600 text-white font-bold hover:bg-purple-700 transition shadow-md"
              >
                수정 완료
              </button>
            </div>
          </form>
        </section>
      </main>
    </div>

    <script>
      // ... (통합 이미지 관리 로직) ...
      const fileInput = document.getElementById('fileInput');
      const finalFileInput = document.getElementById('finalFileInput');
      const listContainer = document.getElementById('image-preview-list');
      const imageOrderInput = document.getElementById('imageOrderInput');

      let allImages = [];
      let newFilesMap = [];

      const existingImages = <%- JSON.stringify(product.images || []) %>;
      existingImages.forEach(img => {
        allImages.push({
            type: 'EXISTING',
            data: img.IMAGE_PATH,
            name: img.IMAGE_PATH.split('/').pop(),
            size: 0
        });
      });

      updateUI();

      fileInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        if (allImages.length + files.length > 5) return alert('최대 5장까지만 등록 가능합니다.');
        files.forEach(file => {
            newFilesMap.push(file);
            const newIndex = newFilesMap.length - 1;
            allImages.push({ type: 'NEW', data: file, name: file.name, size: file.size, newFileIndex: newIndex });
        });
        updateUI(); syncFileInput(); this.value = '';
      });

      function updateUI() {
        listContainer.innerHTML = '';
        if (allImages.length === 0) { listContainer.innerHTML = '<div class="text-sm text-gray-400 text-center py-12">등록된 이미지가 없습니다.</div>'; return; }

        allImages.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'file-item flex items-center gap-3 bg-white p-2 rounded border border-gray-200 shadow-sm transition hover:shadow-md cursor-grab active:cursor-grabbing';
            div.draggable = true; div.dataset.index = index;

            let imgSrc = '';
            if (item.type === 'EXISTING') { imgSrc = item.data; renderItem(div, imgSrc, item, index); }
            else { const reader = new FileReader(); reader.onload = (e) => renderItem(div, e.target.result, item, index); reader.readAsDataURL(item.data); }
            listContainer.appendChild(div);
        });
        addDragEvents(); updateOrderInput();
      }

      function renderItem(div, src, item, index) {
        const sizeText = item.size > 0 ? (item.size / 1024 / 1024).toFixed(2) + ' MB' : '기존';
        const badgeColor = item.type === 'NEW' ? 'bg-blue-50 text-blue-600 border-blue-200' : 'bg-purple-50 text-purple-600 border-purple-100';
        div.innerHTML = `<span class="font-bold text-slate-400 px-2 cursor-move">☰</span><span class="font-bold px-2 py-0.5 rounded text-xs border ${badgeColor}">${index + 1}</span><img src="${src}" class="w-10 h-10 object-cover rounded border border-gray-100"><span class="text-sm text-gray-700 font-medium truncate flex-1">${item.name}</span><span class="text-xs text-gray-400 mr-2">${sizeText}</span><button type="button" onclick="removeItem(${index})" class="text-gray-400 hover:text-red-500 px-2 font-bold">✕</button>`;
      }

      window.removeItem = (index) => { allImages.splice(index, 1); updateUI(); };
      function updateOrderInput() { const orderList = allImages.map(item => { return item.type === 'EXISTING' ? { type: 'EXISTING', path: item.data } : { type: 'NEW', index: item.newFileIndex }; }); imageOrderInput.value = JSON.stringify(orderList); }
      function syncFileInput() { const dt = new DataTransfer(); newFilesMap.forEach(f => dt.items.add(f)); finalFileInput.files = dt.files; }

      function addDragEvents() {
        const items = listContainer.querySelectorAll('.file-item');
        items.forEach(item => {
            item.addEventListener('dragstart', () => item.classList.add('dragging'));
            item.addEventListener('dragend', () => { item.classList.remove('dragging'); reorderList(); });
        });
      }
      listContainer.addEventListener('dragover', e => { e.preventDefault(); const afterElement = getDragAfterElement(listContainer, e.clientY); const draggable = document.querySelector('.dragging'); if (afterElement == null) listContainer.appendChild(draggable); else listContainer.insertBefore(draggable, afterElement); });
      function getDragAfterElement(container, y) {
        const els = [...container.querySelectorAll('.file-item:not(.dragging)')];
        return els.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; if (offset < 0 && offset > closest.offset) return { offset: offset, element: child }; else return closest; }, { offset: Number.NEGATIVE_INFINITY }).element;
      }
      function reorderList() { const newOrder = []; listContainer.querySelectorAll('.file-item').forEach(item => newOrder.push(allImages[item.dataset.index])); allImages = newOrder; updateUI(); }
    </script>
  </body>
</html>
