<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>관리자 - 할인 관리 | EaGCart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .modal {
        transition: opacity 0.25s ease;
      }
      body.modal-active {
        overflow: hidden;
      }
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      /* 툴팁 스타일 */
      #hover-tooltip {
        pointer-events: none;
        z-index: 9999;
        transition: opacity 0.1s ease;
      }
    </style>
  </head>
  <body class="bg-gray-100 font-sans">
    <div class="flex">
      <%- include('./partials/sidebar.ejs', { active }) %>

      <main class="flex-1 p-8 space-y-6 overflow-y-auto h-screen relative">
        <!-- 상단 타이틀 -->
        <div
          class="flex items-center justify-between mb-8 border-b pb-4 border-gray-300"
        >
          <h2 class="text-3xl font-bold text-gray-800">할인 관리</h2>
          <button
            onclick="openDiscountModal()"
            class="inline-flex items-center gap-2 rounded-lg bg-purple-600 text-white px-5 py-2.5 text-sm font-bold hover:bg-purple-700 transition shadow-sm"
          >
            <span>+</span> 할인 등록
          </button>
        </div>

        <!-- 검색 및 필터 영역 -->
        <section class="bg-white p-6 rounded-lg shadow-md mb-6">
          <div class="flex flex-col gap-4">
            <!-- 상단 필터 (기간 + 상태) -->
            <div class="flex flex-wrap items-center gap-6">
              <!-- 기간 설정 (검색용) -->
              <div class="flex items-center gap-2 text-sm text-gray-600">
                <span class="font-bold text-gray-800">기간</span>
                <input
                  type="date"
                  id="searchStartDate"
                  class="border border-gray-300 rounded px-2 py-1 focus:border-purple-500 outline-none transition"
                  value="2025-01-01"
                  onchange="filterDiscount()"
                />
                <span>~</span>
                <input
                  type="date"
                  id="searchEndDate"
                  class="border border-gray-300 rounded px-2 py-1 focus:border-purple-500 outline-none transition"
                  value="2025-12-31"
                  onchange="filterDiscount()"
                />
              </div>

              <!-- 상태 필터 -->
              <div class="flex items-center gap-4 text-sm">
                <span class="font-bold text-gray-800">상태</span>
                <label
                  class="flex items-center gap-1 cursor-pointer hover:text-purple-600 transition"
                >
                  <input
                    type="radio"
                    name="status"
                    value="all"
                    checked
                    class="accent-purple-600"
                    onchange="filterDiscount()"
                  />
                  전체
                </label>
                <label
                  class="flex items-center gap-1 cursor-pointer hover:text-emerald-600 transition"
                >
                  <input
                    type="radio"
                    name="status"
                    value="진행중"
                    class="accent-emerald-500"
                    onchange="filterDiscount()"
                  />
                  진행중
                </label>
                <label
                  class="flex items-center gap-1 cursor-pointer hover:text-gray-600 transition"
                >
                  <input
                    type="radio"
                    name="status"
                    value="종료"
                    class="accent-gray-500"
                    onchange="filterDiscount()"
                  />
                  종료
                </label>
                <label
                  class="flex items-center gap-1 cursor-pointer hover:text-amber-600 transition"
                >
                  <input
                    type="radio"
                    name="status"
                    value="예정"
                    class="accent-amber-500"
                    onchange="filterDiscount()"
                  />
                  예정
                </label>
              </div>
            </div>

            <!-- 검색창 -->
            <div class="relative w-full md:w-1/2 lg:w-1/3">
              <input
                type="text"
                id="searchInput"
                placeholder="할인코드, 상품코드, 상품명 검색"
                class="w-full pl-4 pr-10 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none transition text-sm"
                onkeyup="filterDiscount()"
              />
              <button
                class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-purple-600"
                onclick="filterDiscount()"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                  />
                </svg>
              </button>
            </div>
          </div>
        </section>

        <!-- 할인 목록 테이블 -->
        <section
          class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200"
        >
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-center">
              <thead
                class="bg-gray-50 text-gray-600 font-bold border-b border-gray-200 whitespace-nowrap"
              >
                <tr>
                  <th class="py-3 px-4 w-32">할인코드</th>
                  <th class="py-3 px-4 w-32">상품코드</th>
                  <th class="py-3 px-4 text-left">상품명</th>
                  <th class="py-3 px-4 w-24">정상가</th>
                  <th class="py-3 px-4 w-24 text-rose-600">할인가</th>
                  <th class="py-3 px-4 w-20">할인율</th>
                  <th class="py-3 px-4 w-28">시작일</th>
                  <th class="py-3 px-4 w-28">종료일</th>
                  <th class="py-3 px-4 w-24">상태</th>
                  <th class="py-3 px-4 w-20">관리</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100 text-gray-600">
                <% if (admin.discountTable && admin.discountTable.length > 0) {
                %> <% admin.discountTable.forEach((discount) => { %>
                <tr
                  class="discount-row hover:bg-gray-50 transition duration-150"
                  data-code="<%= discount.code %>"
                  data-product="<%= discount.product %>"
                  data-name="<%= discount.name %>"
                  data-status="<%= discount.status %>"
                  data-start="<%= discount.startDate %>"
                  data-end="<%= discount.endDate %>"
                >
                  <td
                    class="py-3 px-4 font-semibold text-gray-800 whitespace-nowrap"
                  >
                    <%= discount.code %>
                  </td>
                  <td class="py-3 px-4 font-mono text-xs text-gray-500">
                    <%= discount.product %>
                  </td>
                  <td
                    class="py-3 px-4 text-left font-medium text-gray-800 truncate max-w-xs"
                  >
                    <%= discount.name %>
                  </td>
                  <td
                    class="py-3 px-4 text-gray-400 line-through whitespace-nowrap"
                  >
                    <%= discount.normal %>
                  </td>
                  <td
                    class="py-3 px-4 font-bold text-rose-600 whitespace-nowrap"
                  >
                    <%= discount.sale %>
                  </td>
                  <td
                    class="py-3 px-4 font-bold text-purple-600 whitespace-nowrap"
                  >
                    <%= discount.rate %>
                  </td>
                  <td class="py-3 px-4 text-xs text-gray-500 whitespace-nowrap">
                    <%= discount.startDate %>
                  </td>
                  <td class="py-3 px-4 text-xs text-gray-500 whitespace-nowrap">
                    <%= discount.endDate %>
                  </td>
                  <td class="py-3 px-4 whitespace-nowrap">
                    <% if (discount.status === '진행중') { %>
                    <span
                      class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-200"
                      >진행중</span
                    >
                    <% } else if (discount.status === '종료') { %>
                    <span
                      class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-500 border border-gray-200"
                      >종료</span
                    >
                    <% } else { %>
                    <span
                      class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-50 text-amber-700 border border-amber-200"
                      ><%= discount.status %></span
                    >
                    <% } %>
                  </td>
                  <td class="py-3 px-4">
                    <button
                      onclick="openEditModal('<%= discount.code %>')"
                      class="inline-block px-3 py-1 bg-white border border-gray-300 rounded text-xs font-bold text-gray-600 hover:bg-purple-50 hover:text-purple-600 hover:border-purple-200 transition shadow-sm whitespace-nowrap"
                    >
                      관리
                    </button>
                  </td>
                </tr>
                <% }) %> <% } else { %>
                <tr id="noDataRow">
                  <td colspan="10" class="py-12 text-center text-gray-400">
                    등록된 할인 정보가 없습니다.
                  </td>
                </tr>
                <% } %>
                <tr id="noSearchResult" class="hidden">
                  <td colspan="10" class="py-12 text-center text-gray-400">
                    검색 결과가 없습니다.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </main>
    </div>

    <!-- 할인 등록 모달 -->
    <div
      id="discountModal"
      class="modal fixed inset-0 hidden items-center justify-center z-50"
    >
      <div
        class="modal-overlay absolute inset-0 bg-gray-900 opacity-50"
        onclick="closeDiscountModal()"
      ></div>
      <div
        class="modal-container bg-white w-11/12 md:max-w-4xl mx-auto rounded-lg shadow-lg z-50 overflow-visible relative"
        id="modalContent"
      >
        <div class="modal-content py-6 px-8 text-left">
          <div
            class="flex justify-between items-center pb-4 border-b border-gray-200 mb-6"
          >
            <p class="text-2xl font-bold text-gray-800">할인 등록</p>
            <div
              class="cursor-pointer z-50 p-2 hover:bg-gray-100 rounded-full"
              onclick="closeDiscountModal()"
            >
              ✕
            </div>
          </div>

          <form id="discountForm">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <!-- 1. 상품 검색 및 설정 영역 -->
              <div class="space-y-4">
                <label class="block text-sm font-bold text-gray-700"
                  >상품 검색</label
                >
                <div class="relative">
                  <input
                    type="text"
                    id="prodSearch"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition text-sm"
                    placeholder="상품명 또는 코드 입력"
                    onkeyup="searchProduct()"
                  />
                  <div
                    id="searchResultList"
                    class="absolute z-20 w-full bg-white border border-gray-200 rounded-lg shadow-xl mt-1 max-h-48 overflow-y-auto hidden"
                  ></div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label
                      class="block text-xs font-bold text-gray-500 mb-1 uppercase"
                      >할인일 (기간)</label
                    >
                    <div class="relative">
                      <input
                        type="number"
                        id="discountDuration"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition text-sm font-bold text-right pr-8"
                        placeholder="0"
                        oninput="calculateEndDate()"
                      />
                      <span
                        class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm font-bold"
                        >일</span
                      >
                    </div>
                  </div>
                  <div>
                    <label
                      class="block text-xs font-bold text-gray-500 mb-1 uppercase"
                      >할인율 (%)</label
                    >
                    <div class="relative">
                      <input
                        type="number"
                        id="discountValue"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition text-sm font-bold text-right pr-8"
                        placeholder="0"
                        min="1"
                        max="99"
                        required
                        oninput="updateDiscountedPrices()"
                      />
                      <span
                        class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm font-bold"
                        >%</span
                      >
                    </div>
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label
                      class="block text-xs font-bold text-gray-500 mb-1 uppercase"
                      >시작일</label
                    >
                    <input
                      type="date"
                      id="startDateInput"
                      class="w-full p-2 border border-gray-300 rounded-lg text-sm"
                      required
                      onchange="calculateEndDate(true)"
                    />
                  </div>
                  <div>
                    <label
                      class="block text-xs font-bold text-gray-500 mb-1 uppercase"
                      >종료일</label
                    >
                    <input
                      type="date"
                      id="endDateInput"
                      class="w-full p-2 border border-gray-300 rounded-lg text-sm"
                      required
                      onchange="calculateDuration()"
                    />
                  </div>
                </div>
              </div>

              <!-- 2. 선택된 상품 목록 테이블 -->
              <div class="flex flex-col h-full">
                <label class="block text-sm font-bold text-gray-700 mb-2"
                  >할인 적용 상품 목록</label
                >
                <div
                  class="flex-1 border border-gray-200 rounded-lg bg-gray-50 overflow-y-auto h-64 p-0 relative"
                >
                  <table class="min-w-full text-xs text-left">
                    <thead
                      class="bg-purple-50 text-purple-700 sticky top-0 z-10"
                    >
                      <tr>
                        <th class="px-3 py-2 w-20">상품코드</th>
                        <th class="px-3 py-2">상품명</th>
                        <th class="px-3 py-2 text-right">판매가</th>
                        <th
                          class="px-3 py-2 text-right text-rose-500 font-bold"
                        >
                          할인 후
                        </th>
                        <th class="px-3 py-2 text-center w-10">삭제</th>
                      </tr>
                    </thead>
                    <tbody
                      id="selectedProductTableBody"
                      class="divide-y divide-gray-200"
                    >
                      <tr id="emptyRow">
                        <td colspan="5" class="text-center py-10 text-gray-400">
                          상품을 검색하여 추가하세요.
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="flex justify-end pt-6 mt-4 gap-3">
              <button
                type="button"
                class="px-5 py-2.5 bg-gray-100 text-gray-600 rounded-lg font-bold hover:bg-gray-200 transition"
                onclick="closeDiscountModal()"
              >
                취소
              </button>
              <button
                type="button"
                class="px-6 py-2.5 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 transition shadow-sm"
                onclick="submitDiscount()"
              >
                등록하기
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- [할인 수정 모달] -->
    <div
      id="editDiscountModal"
      class="modal fixed inset-0 hidden items-center justify-center z-50"
    >
      <div
        class="modal-overlay absolute inset-0 bg-gray-900 opacity-50"
        onclick="closeEditModal()"
      ></div>
      <div
        class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-lg shadow-lg z-50 overflow-visible relative"
        id="editModalContent"
      >
        <div class="modal-content py-6 px-8 text-left">
          <div
            class="flex justify-between items-center pb-4 border-b border-gray-200 mb-6"
          >
            <p class="text-2xl font-bold text-gray-800">할인 수정</p>
            <div
              class="cursor-pointer z-50 p-2 hover:bg-gray-100 rounded-full"
              onclick="closeEditModal()"
            >
              ✕
            </div>
          </div>

          <form id="editDiscountForm">
            <input type="hidden" id="editDiscountCode" />
            <!-- [추가] 상품 코드 저장을 위한 hidden input -->
            <input type="hidden" id="editProductCode" />

            <div class="space-y-4">
              <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <p
                  class="text-xs text-gray-500 font-mono mb-1"
                  id="editProdCode"
                ></p>
                <p
                  class="text-lg font-bold text-gray-800 mb-2"
                  id="editProdName"
                ></p>
                <div class="flex justify-between text-sm">
                  <span class="text-gray-500">정상가</span>
                  <span class="font-bold" id="editNormalPrice"></span>
                </div>
                <div class="flex justify-between text-sm mt-1">
                  <span class="text-rose-500 font-bold">할인가 (예상)</span>
                  <span
                    class="font-bold text-rose-600"
                    id="editSalePrice"
                  ></span>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label
                    class="block text-xs font-bold text-gray-500 mb-1 uppercase"
                    >할인일</label
                  >
                  <div class="relative">
                    <input
                      type="number"
                      id="editDuration"
                      class="w-full p-3 border border-gray-300 rounded-lg focus:border-purple-500 outline-none transition text-sm font-bold text-right pr-8"
                      oninput="calculateEditEndDate()"
                    />
                    <span
                      class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm font-bold"
                      >일</span
                    >
                  </div>
                </div>
                <div>
                  <label
                    class="block text-xs font-bold text-gray-500 mb-1 uppercase"
                    >할인율 (%)</label
                  >
                  <div class="relative">
                    <input
                      type="number"
                      id="editDiscountValue"
                      class="w-full p-3 border border-gray-300 rounded-lg focus:border-purple-500 outline-none transition text-sm font-bold text-right pr-8"
                      min="1"
                      max="99"
                      oninput="updateEditPrice()"
                    />
                    <span
                      class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm font-bold"
                      >%</span
                    >
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label
                    class="block text-xs font-bold text-gray-500 mb-1 uppercase"
                    >시작일</label
                  >
                  <input
                    type="date"
                    id="editStartDate"
                    class="w-full p-2 border border-gray-300 rounded-lg text-sm"
                    onchange="calculateEditEndDate(true)"
                  />
                </div>
                <div>
                  <label
                    class="block text-xs font-bold text-gray-500 mb-1 uppercase"
                    >종료일</label
                  >
                  <input
                    type="date"
                    id="editEndDate"
                    class="w-full p-2 border border-gray-300 rounded-lg text-sm"
                    onchange="calculateEditDuration()"
                  />
                </div>
              </div>
            </div>

            <div class="flex justify-end pt-6 mt-4 gap-3">
              <button
                type="button"
                class="px-5 py-2.5 bg-gray-100 text-gray-600 rounded-lg font-bold hover:bg-gray-200 transition"
                onclick="closeEditModal()"
              >
                취소
              </button>
              <button
                type="button"
                class="px-6 py-2.5 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 transition shadow-sm"
                onclick="submitEditDiscount()"
              >
                수정하기
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- 호버 툴팁 -->
    <div
      id="hover-tooltip"
      class="fixed hidden bg-white border border-gray-200 shadow-xl rounded-lg p-2 w-auto max-w-xs pointer-events-none"
    >
      <img
        src=""
        id="tooltipImg"
        class="w-full h-auto rounded object-contain bg-gray-50 max-h-48"
      />
      <p class="text-xs text-center text-gray-500 mt-1 font-bold">
        상품 이미지
      </p>
    </div>

    <script>
      function filterDiscount() {
        const searchInput = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const statusFilter = document.querySelector(
          'input[name="status"]:checked'
        ).value;
        const searchStartDate =
          document.getElementById("searchStartDate").value;
        const searchEndDate = document.getElementById("searchEndDate").value;

        const rows = document.querySelectorAll(".discount-row");
        let hasVisibleRow = false;

        rows.forEach((row) => {
          const code = row.getAttribute("data-code").toLowerCase();
          const product = row.getAttribute("data-product").toLowerCase();
          const name = (row.getAttribute("data-name") || "").toLowerCase();
          const status = row.getAttribute("data-status");
          const rowStart = (row.getAttribute("data-start") || "").replace(
            /\./g,
            "-"
          );
          const rowEnd = (row.getAttribute("data-end") || "").replace(
            /\./g,
            "-"
          );

          const isSearchMatch =
            code.includes(searchInput) ||
            product.includes(searchInput) ||
            name.includes(searchInput);
          let isStatusMatch = statusFilter === "all" || status === statusFilter;

          let isDateMatch = true;
          if (searchStartDate && searchEndDate && rowStart && rowEnd) {
            if (rowStart > searchEndDate || rowEnd < searchStartDate)
              isDateMatch = false;
          }

          if (isSearchMatch && isStatusMatch && isDateMatch) {
            row.classList.remove("hidden");
            hasVisibleRow = true;
          } else {
            row.classList.add("hidden");
          }
        });

        const noSearchRow = document.getElementById("noSearchResult");
        const noDataRow = document.getElementById("noDataRow");
        if (!hasVisibleRow) {
          if (!noDataRow) noSearchRow.classList.remove("hidden");
        } else {
          noSearchRow.classList.add("hidden");
        }
      }

      function openDiscountModal() {
        document.getElementById("discountModal").classList.remove("hidden");
        document.getElementById("discountModal").classList.add("flex");
        document.body.classList.add("modal-active");
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("startDateInput").value = today;
        document.getElementById("endDateInput").value = today;
        document.getElementById("discountDuration").value = "";
        selectedProducts = [];
        renderSelectedTable();
        document.getElementById("prodSearch").value = "";
        document.getElementById("discountValue").value = "";
      }

      function closeDiscountModal() {
        document.getElementById("discountModal").classList.add("hidden");
        document.getElementById("discountModal").classList.remove("flex");
        document.body.classList.remove("modal-active");
      }

      function calculateEndDate(isDateChanged = false) {
        const startDateVal = document.getElementById("startDateInput").value;
        const durationVal = document.getElementById("discountDuration").value;
        const endDateInput = document.getElementById("endDateInput");
        if (!startDateVal) return;
        endDateInput.min = startDateVal;
        if (durationVal !== "") {
          const startDate = new Date(startDateVal);
          startDate.setDate(startDate.getDate() + parseInt(durationVal));
          endDateInput.value = startDate.toISOString().split("T")[0];
        }
      }
      function calculateDuration() {
        const startDateVal = document.getElementById("startDateInput").value;
        const endDateVal = document.getElementById("endDateInput").value;
        if (!startDateVal || !endDateVal) return;
        const startDate = new Date(startDateVal);
        const endDate = new Date(endDateVal);
        if (endDate < startDate) {
          alert("종료일은 시작일보다 이전일 수 없습니다.");
          document.getElementById("endDateInput").value = startDateVal;
          document.getElementById("discountDuration").value = 0;
          return;
        }
        const diffTime = endDate - startDate;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        document.getElementById("discountDuration").value = diffDays;
      }

      const searchInput = document.getElementById("prodSearch");
      const resultList = document.getElementById("searchResultList");
      const tooltip = document.getElementById("hover-tooltip");
      const tooltipImg = document.getElementById("tooltipImg");
      let selectedProducts = [];

      async function searchProduct() {
        const query = searchInput.value;
        if (query.length < 1) {
          resultList.classList.add("hidden");
          return;
        }
        try {
          const res = await fetch(
            `/admin/products/search?q=${encodeURIComponent(query)}`
          );
          const data = await res.json();
          resultList.innerHTML = "";
          if (data.success && data.products.length > 0) {
            resultList.classList.remove("hidden");
            data.products.forEach((prod) => {
              const div = document.createElement("div");
              div.className =
                "px-4 py-3 hover:bg-purple-50 cursor-pointer border-b border-gray-100 last:border-0 flex justify-between items-center group";
              div.innerHTML = `<div><p class="text-sm font-bold text-gray-800">${
                prod.name
              }</p><p class="text-xs text-gray-500 font-mono">${
                prod.code
              }</p></div><span class="text-sm font-bold text-gray-600">${parseInt(
                prod.price
              ).toLocaleString()}원</span>`;
              div.addEventListener("mouseenter", (e) => {
                if (prod.thumbnail) {
                  tooltipImg.src = prod.thumbnail;
                  tooltip.classList.remove("hidden");
                  moveTooltip(e);
                }
              });
              div.addEventListener("mousemove", moveTooltip);
              div.addEventListener("mouseleave", () => {
                tooltip.classList.add("hidden");
              });
              div.addEventListener("click", () => {
                addProduct(prod);
              });
              resultList.appendChild(div);
            });
          } else {
            resultList.classList.add("hidden");
          }
        } catch (e) {
          console.error(e);
        }
      }

      function moveTooltip(e) {
        const offset = 15;
        tooltip.style.left = e.clientX + offset + "px";
        tooltip.style.top = e.clientY + offset + "px";
      }

      function addProduct(prod) {
        if (selectedProducts.some((p) => p.code === prod.code))
          return alert("이미 선택된 상품입니다.");
        selectedProducts.push(prod);
        renderSelectedTable();
        searchInput.value = "";
        resultList.classList.add("hidden");
        tooltip.classList.add("hidden");
        searchInput.focus();
        updateDiscountedPrices();
      }

      function removeProduct(code) {
        selectedProducts = selectedProducts.filter((p) => p.code !== code);
        renderSelectedTable();
        updateDiscountedPrices();
      }

      function renderSelectedTable() {
        const tbody = document.getElementById("selectedProductTableBody");
        tbody.innerHTML = "";
        if (selectedProducts.length === 0) {
          tbody.innerHTML =
            '<tr id="emptyRow"><td colspan="5" class="text-center py-10 text-gray-400">상품을 검색하여 추가하세요.</td></tr>';
          return;
        }
        selectedProducts.forEach((prod) => {
          const tr = document.createElement("tr");
          tr.className = "bg-white border-b border-gray-100 last:border-0";
          tr.innerHTML = `<td class="px-3 py-2 font-mono text-gray-500 text-[10px]">${
            prod.code
          }</td><td class="px-3 py-2 font-medium text-gray-800 truncate max-w-[100px]" title="${
            prod.name
          }">${
            prod.name
          }</td><td class="px-3 py-2 text-right text-gray-500">${parseInt(
            prod.price
          ).toLocaleString()}</td><td class="px-3 py-2 text-right font-bold text-rose-600 discounted-price-cell" data-price="${
            prod.price
          }">-</td><td class="px-3 py-2 text-center"><button type="button" onclick="removeProduct('${
            prod.code
          }')" class="text-gray-400 hover:text-red-500 font-bold px-2">✕</button></td>`;
          tbody.appendChild(tr);
        });
      }

      function updateDiscountedPrices() {
        const rate =
          parseInt(document.getElementById("discountValue").value) || 0;
        const cells = document.querySelectorAll(".discounted-price-cell");
        cells.forEach((cell) => {
          const originalPrice = parseInt(cell.dataset.price);
          if (rate > 0 && rate < 100) {
            const discounted = Math.floor(originalPrice * (1 - rate / 100));
            cell.textContent = discounted.toLocaleString();
          } else {
            cell.textContent = originalPrice.toLocaleString();
          }
        });
      }

      document.addEventListener("click", function (e) {
        if (!searchInput.contains(e.target) && !resultList.contains(e.target))
          resultList.classList.add("hidden");
      });

      async function submitDiscount() {
        const discountValue = document.getElementById("discountValue").value;
        const startDate = document.getElementById("startDateInput").value;
        const endDate = document.getElementById("endDateInput").value;
        if (selectedProducts.length === 0)
          return alert("할인할 상품을 1개 이상 선택해주세요.");
        if (!discountValue) return alert("할인율을 입력해주세요.");
        const productCodes = selectedProducts.map((p) => p.code);
        try {
          const res = await fetch("/admin/discount/new", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              productCodes,
              discountValue: parseInt(discountValue),
              startDate,
              endDate,
            }),
          });
          const data = await res.json();
          if (data.success) {
            alert("할인이 등록되었습니다.");
            location.reload();
          } else {
            alert("등록 실패: " + data.message);
          }
        } catch (e) {
          console.error(e);
          alert("서버 통신 오류");
        }
      }

      let currentEditPrice = 0;
      async function openEditModal(code) {
        try {
          const res = await fetch(`/admin/discount/detail/${code}`);
          const data = await res.json();
          if (!data.success) return alert(data.message);
          const info = data.discount;
          document.getElementById("editDiscountCode").value =
            info.DISCOUNT_CODE;

          // [추가] 상품 코드 값을 hidden input에 저장 (서버 전송용)
          document.getElementById("editProductCode").value = info.PRODUCT_CODE;

          document.getElementById("editProdCode").textContent =
            info.PRODUCT_CODE;
          document.getElementById("editProdName").textContent =
            info.PRODUCT_NAME;
          currentEditPrice = info.SELLING_PRICE;
          document.getElementById("editNormalPrice").textContent =
            currentEditPrice.toLocaleString() + "원";
          document.getElementById("editDiscountValue").value =
            info.DISCOUNT_RATE;
          document.getElementById("editStartDate").value = info.START_DATE;
          document.getElementById("editEndDate").value = info.END_DATE;
          calculateEditDuration();
          updateEditPrice();
          const modal = document.getElementById("editDiscountModal");
          modal.classList.remove("hidden");
          modal.classList.add("flex");
          document.body.classList.add("modal-active");
        } catch (e) {
          console.error(e);
          alert("정보를 불러오지 못했습니다.");
        }
      }

      function closeEditModal() {
        document.getElementById("editDiscountModal").classList.add("hidden");
        document.getElementById("editDiscountModal").classList.remove("flex");
        document.body.classList.remove("modal-active");
      }

      function updateEditPrice() {
        const rate =
          parseInt(document.getElementById("editDiscountValue").value) || 0;
        const discounted = Math.floor(currentEditPrice * (1 - rate / 100));
        document.getElementById("editSalePrice").textContent =
          discounted.toLocaleString() + "원";
      }

      function calculateEditEndDate(isDateChanged = false) {
        const startVal = document.getElementById("editStartDate").value;
        const durationVal = document.getElementById("editDuration").value;
        const endInput = document.getElementById("editEndDate");
        if (!startVal) return;
        endInput.min = startVal;
        if (durationVal !== "") {
          const startDate = new Date(startVal);
          startDate.setDate(startDate.getDate() + parseInt(durationVal));
          endInput.value = startDate.toISOString().split("T")[0];
        }
      }

      function calculateEditDuration() {
        const startVal = document.getElementById("editStartDate").value;
        const endVal = document.getElementById("editEndDate").value;
        if (!startVal || !endVal) return;
        const start = new Date(startVal);
        const end = new Date(endVal);
        const diffDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
        document.getElementById("editDuration").value = diffDays;
      }

      async function submitEditDiscount() {
        const code = document.getElementById("editDiscountCode").value;
        const productCode = document.getElementById("editProductCode").value; // [추가]
        const discountValue =
          document.getElementById("editDiscountValue").value;
        const startDate = document.getElementById("editStartDate").value;
        const endDate = document.getElementById("editEndDate").value;
        if (!discountValue) return alert("할인율을 입력해주세요.");
        try {
          const res = await fetch("/admin/discount/update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              code,
              discountValue,
              startDate,
              endDate,
              productCode, // [추가] 서버로 함께 전송
            }),
          });
          const data = await res.json();
          if (data.success) {
            alert("수정되었습니다.");
            location.reload();
          } else {
            alert("수정 실패: " + data.message);
          }
        } catch (e) {
          alert("서버 통신 오류");
        }
      }
    </script>
  </body>
</html>
