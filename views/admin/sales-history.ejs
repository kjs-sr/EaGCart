<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>관리자 - 판매 기록 | EaGCart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .modal {
        transition: opacity 0.25s ease;
      }
      body.modal-active {
        overflow: hidden;
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
      }
    </style>
  </head>
  <body class="bg-gray-100 font-sans">
    <div class="flex">
      <%- include('./partials/sidebar.ejs', { active }) %>

      <main class="flex-1 p-8 space-y-6 overflow-y-auto h-screen relative">
        <!-- 타이틀 -->
        <div
          class="flex items-center justify-between mb-8 border-b pb-4 border-gray-300"
        >
          <h2 class="text-3xl font-bold text-gray-800">판매 기록</h2>
        </div>

        <!-- 검색 및 필터 -->
        <section class="bg-white p-6 rounded-lg shadow-md mb-6">
          <div class="flex flex-col gap-4">
            <!-- 날짜 필터 & 체크박스 -->
            <div
              class="flex items-center justify-between gap-2 text-sm text-gray-600"
            >
              <div class="flex items-center gap-2">
                <span class="font-bold text-gray-800 w-16">주문일</span>
                <input
                  type="date"
                  id="startDate"
                  class="border border-gray-300 rounded px-3 py-2 focus:border-purple-500 outline-none transition"
                  onchange="fetchSalesData()"
                />
                <span>~</span>
                <input
                  type="date"
                  id="endDate"
                  class="border border-gray-300 rounded px-3 py-2 focus:border-purple-500 outline-none transition"
                  onchange="fetchSalesData()"
                />
              </div>

              <!-- [신규] 클레임 필터 체크박스 -->
              <label
                class="flex items-center gap-2 cursor-pointer bg-rose-50 px-4 py-2 rounded-lg border border-rose-100 hover:bg-rose-100 transition"
              >
                <input
                  type="checkbox"
                  id="claimCheck"
                  class="w-4 h-4 accent-rose-500"
                  onchange="fetchSalesData()"
                />
                <span class="font-bold text-rose-600"
                  >클레임 있는 주문만 보기</span
                >
              </label>
            </div>

            <!-- 검색창 -->
            <div
              class="flex items-center gap-2 text-sm text-gray-600 w-full md:w-1/2 lg:w-1/3"
            >
              <span class="font-bold text-gray-800 w-16">검색</span>
              <div class="relative flex-1">
                <input
                  type="text"
                  id="searchInput"
                  placeholder="주문코드, 주문자(ID/이름)"
                  class="w-full pl-4 pr-10 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none transition text-sm"
                  oninput="fetchSalesData()"
                />
                <button
                  class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-purple-600"
                  onclick="fetchSalesData()"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                    />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- 판매 목록 테이블 -->
        <section
          class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200"
        >
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-center">
              <thead
                class="bg-gray-50 text-gray-600 font-bold border-b border-gray-200 whitespace-nowrap"
              >
                <tr>
                  <th class="py-3 px-4 w-32">주문코드</th>
                  <th class="py-3 px-4 w-32">주문자</th>
                  <th class="py-3 px-4 text-left">주문 상품</th>
                  <th class="py-3 px-4 w-32">주문일자</th>
                  <th class="py-3 px-4 w-32">결제금액</th>
                  <th class="py-3 px-4 w-24">클레임</th>
                  <th class="py-3 px-4 w-32">상태</th>
                  <th class="py-3 px-4 w-20">상세</th>
                </tr>
              </thead>
              <tbody
                class="divide-y divide-gray-100 text-gray-600"
                id="salesTableBody"
              >
                <!-- 자바스크립트로 데이터 로드됨 -->
                <tr id="loadingRow">
                  <td colspan="8" class="py-12 text-center text-gray-400">
                    데이터를 불러오는 중...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </main>
    </div>

    <!-- [주문 상세 모달] -->
    <div
      id="detailModal"
      class="modal fixed inset-0 hidden items-center justify-center z-50"
    >
      <div
        class="modal-overlay absolute inset-0 bg-gray-900 opacity-50"
        onclick="closeDetailModal()"
      ></div>
      <div
        class="modal-container bg-white w-11/12 md:max-w-2xl mx-auto rounded-lg shadow-lg z-50 p-6 text-left max-h-[90vh] flex flex-col"
      >
        <div
          class="flex justify-between items-center mb-4 border-b pb-4 shrink-0"
        >
          <h3 class="text-xl font-bold text-gray-800">주문 상세 정보</h3>
          <button
            class="text-gray-500 hover:text-gray-800"
            onclick="closeDetailModal()"
          >
            ✕
          </button>
        </div>

        <div class="overflow-y-auto custom-scrollbar pr-2 flex-1">
          <div
            class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4 text-sm"
          >
            <div class="flex justify-between mb-2">
              <span class="text-gray-500 font-bold">주문번호</span>
              <span id="modalOrderCode" class="font-mono text-gray-800"></span>
            </div>
            <div class="flex justify-between mb-2">
              <span class="text-gray-500 font-bold">주문자</span>
              <span id="modalCustomer" class="text-gray-800"></span>
            </div>
            <div class="flex justify-between mb-2">
              <span class="text-gray-500 font-bold">주문일자</span>
              <span id="modalDate" class="text-gray-800"></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500 font-bold">총 결제금액</span>
              <span
                id="modalPrice"
                class="font-bold text-rose-600 text-lg"
              ></span>
            </div>
          </div>

          <h4 class="text-sm font-bold text-gray-700 mb-2">주문 품목 관리</h4>
          <div id="modalItemList" class="space-y-3"></div>
        </div>

        <div class="flex justify-end pt-4 mt-2 border-t border-gray-100">
          <button
            type="button"
            class="px-5 py-2.5 bg-gray-100 rounded-lg font-bold text-gray-600 hover:bg-gray-200 transition text-sm"
            onclick="closeDetailModal()"
          >
            닫기
          </button>
        </div>
      </div>
    </div>

    <script>
      let currentOrderCode = "";
      let searchTimeout;

      document.addEventListener("DOMContentLoaded", () => {
        const startDateInput = document.getElementById("startDate");
        const endDateInput = document.getElementById("endDate");

        const today = new Date();
        const threeMonthsAgo = new Date();
        threeMonthsAgo.setMonth(today.getMonth() - 3);

        const toYMD = (d) => {
          return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(
            2,
            "0"
          )}-${String(d.getDate()).padStart(2, "0")}`;
        };

        endDateInput.value = toYMD(today);
        startDateInput.value = toYMD(threeMonthsAgo);

        fetchSalesData();
      });

      async function fetchSalesData() {
        const searchInput = document.getElementById("searchInput").value.trim();
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;
        // [신규] 체크박스 상태 확인
        const onlyClaim = document.getElementById("claimCheck").checked;

        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(async () => {
          try {
            const params = new URLSearchParams({
              startDate,
              endDate,
              search: searchInput,
              type: "json",
              claim: onlyClaim, // [신규] 파라미터 추가
            });

            const res = await fetch(
              `/admin/sales-history?${params.toString()}`
            );
            const data = await res.json();

            if (data.success) {
              renderTable(data.sales);
            } else {
              alert("데이터를 불러오지 못했습니다.");
            }
          } catch (e) {
            console.error(e);
          }
        }, 300);
      }

      function renderTable(sales) {
        const tbody = document.getElementById("salesTableBody");
        tbody.innerHTML = "";

        if (!sales || sales.length === 0) {
          tbody.innerHTML = `
                <tr>
                  <td colspan="8" class="py-12 text-center text-gray-400">
                    판매 기록이 없습니다.
                  </td>
                </tr>`;
          return;
        }

        sales.forEach((order) => {
          let statusBadge = "";
          if (order.status === "DELIVERED") {
            statusBadge =
              '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-200">배송완료</span>';
          } else if (order.status === "SHIPPING") {
            statusBadge =
              '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-50 text-amber-700 border border-amber-200">배송중</span>';
          } else if (order.status === "CANCELLED") {
            statusBadge =
              '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-500 border border-gray-200">취소됨</span>';
          } else {
            statusBadge =
              '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-50 text-purple-700 border border-purple-200">결제완료</span>';
          }

          let claimBadge = "-";
          let rowClass = "hover:bg-gray-50 transition duration-150";

          if (order.hasClaim) {
            claimBadge =
              '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-rose-500 text-white shadow-sm animate-pulse">확인 필요</span>';
            rowClass =
              "bg-rose-50 hover:bg-rose-100 transition duration-150 border-l-4 border-rose-500";
          }

          const tr = document.createElement("tr");
          tr.className = rowClass;
          tr.innerHTML = `
                <td class="py-3 px-4 font-mono text-xs text-gray-500">${
                  order.code
                }</td>
                <td class="py-3 px-4 font-medium text-gray-800">
                    ${order.customerName}
                    <br /><span class="text-xs text-gray-400 font-normal">(${
                      order.customerId
                    })</span>
                </td>
                <td class="py-3 px-4 text-left text-gray-800 font-medium truncate max-w-xs" title="${
                  order.productSummary
                }">
                    ${order.productSummary}
                </td>
                <td class="py-3 px-4 text-xs text-gray-400 whitespace-nowrap">${
                  order.date
                }</td>
                <td class="py-3 px-4 font-bold text-slate-700">${order.price.toLocaleString()}원</td>
                <td class="py-3 px-4">${claimBadge}</td>
                <td class="py-3 px-4 whitespace-nowrap">${statusBadge}</td>
                <td class="py-3 px-4">
                    <button onclick="openDetailModal('${order.code}', '${
            order.customerName
          }', '${order.date}', '${order.price}')"
                        class="inline-block px-3 py-1 bg-white border border-gray-300 rounded text-xs font-bold text-gray-600 hover:bg-purple-50 hover:text-purple-600 hover:border-purple-200 transition shadow-sm whitespace-nowrap">
                        상세보기
                    </button>
                </td>
            `;
          tbody.appendChild(tr);
        });
      }

      async function openDetailModal(code, customer, date, price) {
        currentOrderCode = code;
        document.getElementById("modalOrderCode").textContent = code;
        document.getElementById("modalCustomer").textContent = customer;
        document.getElementById("modalDate").textContent = date;
        const priceVal =
          typeof price === "string" ? price.replace(/[^0-9]/g, "") : price;
        document.getElementById("modalPrice").textContent =
          parseInt(priceVal).toLocaleString() + "원";

        const listContainer = document.getElementById("modalItemList");
        listContainer.innerHTML =
          '<p class="text-center text-gray-400 py-4 text-xs">불러오는 중...</p>';

        try {
          const res = await fetch(`/admin/sales-history/detail/${code}`);
          const data = await res.json();

          if (data.success && data.items.length > 0) {
            listContainer.innerHTML = "";
            data.items.forEach((item) => {
              const img = item.image
                ? `<img src="${item.image}" class="w-full h-full object-contain">`
                : `<div class="w-full h-full bg-gray-100 flex items-center justify-center text-xs text-gray-400">No Img</div>`;

              let statusHtml = "";
              let actionButtons = "";

              if (item.status === "RETURN_REQUESTED") {
                statusHtml = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-rose-50 text-rose-600 border border-rose-200">반품신청</span>`;
                actionButtons = `
                    <div class="mt-2 flex gap-2 justify-end">
                        <button onclick="processClaim('${item.productCode}', 'APPROVE_RETURN', ${item.qty})" class="px-3 py-1 bg-rose-500 text-white text-xs font-bold rounded hover:bg-rose-600 transition">반품 승인</button>
                        <button onclick="processClaim('${item.productCode}', 'REJECT', ${item.qty})" class="px-3 py-1 bg-gray-200 text-gray-600 text-xs font-bold rounded hover:bg-gray-300 transition">거절</button>
                    </div>
                `;
              } else if (item.status === "EXCHANGE_REQUESTED") {
                statusHtml = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-amber-50 text-amber-600 border border-amber-200">교환신청</span>`;
                actionButtons = `
                    <div class="mt-2 flex gap-2 justify-end">
                        <button onclick="processClaim('${item.productCode}', 'APPROVE_EXCHANGE', ${item.qty})" class="px-3 py-1 bg-amber-500 text-white text-xs font-bold rounded hover:bg-amber-600 transition">교환 승인</button>
                        <button onclick="processClaim('${item.productCode}', 'REJECT', ${item.qty})" class="px-3 py-1 bg-gray-200 text-gray-600 text-xs font-bold rounded hover:bg-gray-300 transition">거절</button>
                    </div>
                `;
              } else if (item.status === "RETURNED") {
                statusHtml = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-gray-100 text-gray-500">반품완료</span>`;
              } else if (item.status === "EXCHANGED") {
                statusHtml = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-gray-100 text-gray-500">교환완료</span>`;
              } else {
                statusHtml = `<span class="px-2 py-0.5 rounded text-[10px] font-bold bg-gray-100 text-gray-500">${item.status}</span>`;
              }

              let reasonHtml = "";
              if (item.claimReason && item.status.includes("REQUESTED")) {
                const parts = item.claimReason.split("|");
                const reasonText =
                  parts.length > 1 ? parts[1] : item.claimReason;
                reasonHtml = `<p class="text-xs text-rose-500 mt-1 bg-rose-50 p-1 rounded">사유: ${reasonText}</p>`;
              }

              const html = `
                        <div class="flex items-start gap-3 p-3 bg-white border border-gray-100 rounded-lg shadow-sm">
                            <div class="w-14 h-14 rounded-lg border border-gray-200 overflow-hidden flex-shrink-0">
                                ${img}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <p class="text-sm font-bold text-gray-800 truncate pr-2">${
                                      item.productName
                                    }</p>
                                    ${statusHtml}
                                </div>
                                <div class="flex justify-between items-end mt-1">
                                    <p class="text-xs text-gray-500">수량: ${
                                      item.qty
                                    }개</p>
                                    <p class="text-sm font-bold text-slate-700">${item.price.toLocaleString()}원</p>
                                </div>
                                ${reasonHtml}
                                ${actionButtons}
                            </div>
                        </div>
                    `;
              listContainer.insertAdjacentHTML("beforeend", html);
            });
          } else {
            listContainer.innerHTML =
              '<p class="text-center text-gray-400 py-4 text-xs">품목 정보가 없습니다.</p>';
          }

          const modal = document.getElementById("detailModal");
          modal.classList.remove("hidden");
          modal.classList.add("flex");
          document.body.classList.add("modal-active");
        } catch (e) {
          console.error(e);
          listContainer.innerHTML =
            '<p class="text-center text-red-400 py-4 text-xs">오류가 발생했습니다.</p>';
        }
      }

      function closeDetailModal() {
        const modal = document.getElementById("detailModal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
        document.body.classList.remove("modal-active");
      }

      async function processClaim(productCode, action, qty) {
        const reason = prompt(
          action === "REJECT"
            ? "거절 사유를 입력해주세요 (필수):"
            : "처리 사유를 입력해주세요 (선택사항):"
        );

        if (action === "REJECT" && (!reason || reason.trim() === "")) {
          return alert("거절 사유는 필수입니다.");
        }

        if (reason === null) return;

        if (!confirm("정말 처리하시겠습니까?")) return;

        try {
          const res = await fetch("/admin/sales-history/claim", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              orderCode: currentOrderCode,
              productCode: productCode,
              action: action,
              qty: qty,
              reason: reason,
            }),
          });
          const data = await res.json();

          if (data.success) {
            alert(data.message);
            fetchSalesData();
            const orderDate = document.getElementById("modalDate").textContent;
            const orderPrice = document
              .getElementById("modalPrice")
              .textContent.replace(/[^0-9]/g, "");
            const customer =
              document.getElementById("modalCustomer").textContent;
            openDetailModal(currentOrderCode, customer, orderDate, orderPrice);
          } else {
            alert("실패: " + data.message);
          }
        } catch (e) {
          console.error(e);
          alert("서버 통신 오류");
        }
      }
    </script>
  </body>
</html>
