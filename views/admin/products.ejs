<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>관리자 - 상품 관리 | EaGCart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      #image-tooltip {
        pointer-events: none;
        transition: opacity 0.15s ease;
        z-index: 9999;
      }
    </style>
  </head>
  <body class="bg-gray-100 font-sans">
    <div class="flex">
      <%- include('./partials/sidebar.ejs', { active }) %>

      <main class="flex-1 p-8 space-y-6 overflow-y-auto h-screen relative">
        <!-- 1. 페이지 타이틀 -->
        <div
          class="flex items-center justify-between mb-8 border-b pb-4 border-gray-300"
        >
          <h2 class="text-3xl font-bold text-gray-800">상품 관리</h2>
          <a
            href="/admin/products/new"
            class="inline-flex items-center gap-2 rounded-lg bg-purple-600 text-white px-5 py-2.5 text-sm font-bold hover:bg-purple-700 transition shadow-sm"
          >
            <span>+</span> 상품 등록
          </a>
        </div>

        <!-- 2. 검색 및 필터 영역 -->
        <section class="bg-white p-6 rounded-lg shadow-md mb-6">
          <div class="flex flex-col gap-4">
            <!-- 상단 필터 -->
            <div class="flex flex-wrap items-center gap-6">
              <!-- 기간 (날짜 필터) -->
              <div class="flex items-center gap-2 text-sm text-gray-600">
                <span class="font-bold text-gray-800">기간</span>
                <input
                  type="date"
                  id="startDate"
                  class="border border-gray-300 rounded px-2 py-1 focus:border-purple-500 outline-none"
                  onchange="filterProducts()"
                />
                <span>~</span>
                <input
                  type="date"
                  id="endDate"
                  class="border border-gray-300 rounded px-2 py-1 focus:border-purple-500 outline-none"
                  onchange="filterProducts()"
                />
              </div>

              <!-- 상태 (라디오 버튼 필터) -->
              <div class="flex items-center gap-4 text-sm">
                <span class="font-bold text-gray-800">상태</span>
                <label
                  class="flex items-center gap-1 cursor-pointer hover:text-purple-600 transition"
                >
                  <input
                    type="radio"
                    name="status"
                    value="all"
                    checked
                    class="accent-purple-600"
                    onchange="filterProducts()"
                  />
                  전체
                </label>
                <label
                  class="flex items-center gap-1 cursor-pointer hover:text-emerald-600 transition"
                >
                  <input
                    type="radio"
                    name="status"
                    value="판매중"
                    class="accent-emerald-500"
                    onchange="filterProducts()"
                  />
                  판매
                </label>
                <label
                  class="flex items-center gap-1 cursor-pointer hover:text-gray-600 transition"
                >
                  <input
                    type="radio"
                    name="status"
                    value="품절"
                    class="accent-gray-500"
                    onchange="filterProducts()"
                  />
                  품절
                </label>
                <label
                  class="flex items-center gap-1 cursor-pointer hover:text-rose-600 transition"
                >
                  <input
                    type="radio"
                    name="status"
                    value="중지"
                    class="accent-rose-500"
                    onchange="filterProducts()"
                  />
                  중지
                </label>
              </div>
            </div>

            <!-- 검색창 -->
            <div class="relative w-full md:w-1/2 lg:w-1/3">
              <input
                type="text"
                id="searchInput"
                placeholder="상품 코드 또는 상품명 검색"
                class="w-full pl-4 pr-10 py-2 border border-gray-300 rounded-lg focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none transition text-sm"
                onkeyup="filterProducts()"
              />
              <button
                class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-purple-600"
                onclick="filterProducts()"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                  />
                </svg>
              </button>
            </div>
          </div>
        </section>

        <!-- 3. 상품 목록 테이블 -->
        <section
          class="bg-white rounded-lg shadow-md overflow-visible border border-gray-200"
        >
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-center">
              <thead
                class="bg-gray-50 text-gray-600 font-bold border-b border-gray-200 whitespace-nowrap"
              >
                <tr>
                  <th class="py-3 px-4 w-32">상품코드</th>
                  <th class="py-3 px-4 text-left">상품명</th>
                  <th class="py-3 px-4 w-40">기기</th>
                  <th class="py-3 px-4 w-32">카테고리</th>
                  <th class="py-3 px-4 w-32">판매가</th>
                  <th class="py-3 px-4 w-32">등록일</th>
                  <th class="py-3 px-4 w-32">수정일</th>
                  <th class="py-3 px-4 w-24">상태</th>
                  <th class="py-3 px-4 w-24">관리</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100 text-gray-600">
                <% if (admin.productTable && admin.productTable.length > 0) { %>
                <% admin.productTable.forEach((row) => { %>

                <!-- [중요] 필터링용 데이터 속성 추가 -->
                <tr
                  class="product-row hover:bg-gray-50 transition duration-150 cursor-pointer"
                  data-image="<%= row.thumbnail %>"
                  data-code="<%= row.code %>"
                  data-name="<%= row.name %>"
                  data-status="<%= row.status %>"
                  data-date="<%= row.regDate %>"
                >
                  <!-- date format: YYYY.MM.DD -->

                  <td
                    class="py-3 px-4 font-semibold text-gray-800 whitespace-nowrap"
                  >
                    <%= row.code %>
                  </td>
                  <td
                    class="py-3 px-4 font-medium text-left truncate max-w-xs relative"
                  >
                    <%= row.name %>
                  </td>
                  <td class="py-3 px-4 text-xs whitespace-nowrap">
                    <span
                      class="inline-block bg-gray-100 px-2 py-1 rounded text-gray-500 truncate max-w-[140px]"
                      title="<%= row.device %>"
                      ><%= row.device %></span
                    >
                  </td>
                  <td
                    class="py-3 px-4 text-xs truncate max-w-[100px]"
                    title="<%= row.category %>"
                  >
                    <%= row.category %>
                  </td>
                  <td
                    class="py-3 px-4 font-bold text-gray-800 whitespace-nowrap"
                  >
                    <%= row.price %>원
                  </td>
                  <td class="py-3 px-4 text-xs text-gray-400 whitespace-nowrap">
                    <%= row.regDate %>
                  </td>
                  <td class="py-3 px-4 text-xs text-gray-400 whitespace-nowrap">
                    <%= row.modDate %>
                  </td>
                  <td class="py-3 px-4 whitespace-nowrap">
                    <span
                      class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border <%= row.status === '판매중' ? 'bg-green-50 text-green-700 border-green-200' : (row.status === '품절' ? 'bg-gray-100 text-gray-500 border-gray-200' : 'bg-red-50 text-red-700 border-red-200') %>"
                    >
                      <%= row.status %>
                    </span>
                  </td>
                  <td class="py-3 px-4">
                    <a
                      href="/admin/products/edit/<%= row.code %>"
                      class="inline-block px-3 py-1.5 bg-white border border-gray-300 rounded text-xs font-bold text-gray-600 hover:bg-purple-600 hover:text-white hover:border-purple-600 transition shadow-sm whitespace-nowrap"
                    >
                      상품 수정
                    </a>
                  </td>
                </tr>
                <% }) %> <% } else { %>
                <tr id="noDataRow">
                  <td colspan="9" class="py-12 text-center text-gray-400">
                    등록된 상품이 없습니다.
                  </td>
                </tr>
                <% } %>
                <!-- 검색 결과 없음 메시지 -->
                <tr id="noSearchResult" class="hidden">
                  <td colspan="9" class="py-12 text-center text-gray-400">
                    검색 결과가 없습니다.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </main>
    </div>

    <!-- 이미지 미리보기 툴팁 -->
    <div
      id="image-tooltip"
      class="fixed hidden bg-white border border-gray-200 shadow-2xl rounded-lg p-2 w-auto max-w-lg min-w-[150px]"
    >
      <img
        src=""
        alt="상품 미리보기"
        class="w-full h-auto max-h-[30rem] rounded object-contain bg-gray-50"
      />
      <p class="text-xs text-center text-gray-500 mt-2 font-bold">
        대표 이미지
      </p>
    </div>

    <script>
      // 1. 초기화: 날짜 필터 기본값 설정 (오늘 ~ 6개월 전)
      window.onload = function () {
        const today = new Date();
        const sixMonthsAgo = new Date();
        sixMonthsAgo.setMonth(today.getMonth() - 6);

        // YYYY-MM-DD 형식으로 변환 함수
        const formatDate = (date) => {
          const y = date.getFullYear();
          const m = String(date.getMonth() + 1).padStart(2, "0");
          const d = String(date.getDate()).padStart(2, "0");
          return `${y}-${m}-${d}`;
        };

        document.getElementById("endDate").value = formatDate(today);
        document.getElementById("startDate").value = formatDate(sixMonthsAgo);
      };

      // 2. 이미지 툴팁 로직
      const tooltip = document.getElementById("image-tooltip");
      const tooltipImg = tooltip.querySelector("img");
      const rows = document.querySelectorAll(".product-row");

      rows.forEach((row) => {
        row.addEventListener("mouseenter", () => {
          const imgSrc = row.getAttribute("data-image");
          if (imgSrc && imgSrc !== "null" && imgSrc !== "") {
            tooltipImg.src = imgSrc;
            tooltip.classList.remove("hidden");
          }
        });

        row.addEventListener("mousemove", (e) => {
          const offsetX = 20;
          const offsetY = 20;
          const windowWidth = window.innerWidth;
          const windowHeight = window.innerHeight;
          const tooltipRect = tooltip.getBoundingClientRect();
          const tooltipWidth = tooltipRect.width;
          const tooltipHeight = tooltipRect.height;

          let left = e.clientX + offsetX;
          let top = e.clientY + offsetY;

          if (left + tooltipWidth > windowWidth - 20)
            left = e.clientX - tooltipWidth - offsetX;
          if (top + tooltipHeight > windowHeight - 20)
            top = e.clientY - tooltipHeight - offsetY;

          tooltip.style.left = left + "px";
          tooltip.style.top = top + "px";
        });

        row.addEventListener("mouseleave", () => {
          tooltip.classList.add("hidden");
          tooltipImg.src = "";
        });
      });

      // 3. 필터링 로직 (검색 + 상태 + 날짜)
      function filterProducts() {
        const searchInput = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const statusFilter = document.querySelector(
          'input[name="status"]:checked'
        ).value;
        const startDate = document.getElementById("startDate").value; // YYYY-MM-DD
        const endDate = document.getElementById("endDate").value; // YYYY-MM-DD

        let hasVisible = false;

        rows.forEach((row) => {
          const name = row.getAttribute("data-name").toLowerCase();
          const code = row.getAttribute("data-code").toLowerCase();
          const status = row.getAttribute("data-status");

          // data-date는 "YYYY.MM.DD" 형식이므로 비교를 위해 "YYYY-MM-DD"로 변환
          const rawDate = row.getAttribute("data-date");
          const dateStr = rawDate ? rawDate.replace(/\./g, "-") : "";

          // (1) 검색어 필터 (코드 또는 이름)
          const isSearchMatch =
            name.includes(searchInput) || code.includes(searchInput);

          // (2) 상태 필터
          const isStatusMatch =
            statusFilter === "all" || status === statusFilter;

          // (3) 날짜 필터
          let isDateMatch = true;
          if (dateStr) {
            if (startDate && dateStr < startDate) isDateMatch = false;
            if (endDate && dateStr > endDate) isDateMatch = false;
          }

          // 최종 판단
          if (isSearchMatch && isStatusMatch && isDateMatch) {
            row.classList.remove("hidden");
            hasVisible = true;
          } else {
            row.classList.add("hidden");
          }
        });

        // 결과 없음 표시 처리
        const noSearchRow = document.getElementById("noSearchResult");
        const noDataRow = document.getElementById("noDataRow");

        if (!hasVisible) {
          // 데이터가 있는데 필터링 결과가 없는 경우만 표시
          if (!noDataRow) noSearchRow.classList.remove("hidden");
        } else {
          noSearchRow.classList.add("hidden");
        }
      }
    </script>
  </body>
</html>
