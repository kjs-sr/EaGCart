<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë§ˆì´í˜ì´ì§€ - ì£¼ë¬¸ ëª©ë¡ | EaGCart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .modal {
        transition: opacity 0.25s ease;
      }
      body.modal-active {
        overflow: hidden;
      }
    </style>
  </head>
  <body class="bg-slate-50 min-h-screen flex flex-col">
    <%- include('../partials/header.ejs') %>

    <main
      class="max-w-7xl mx-auto w-full px-6 py-12 grid gap-8 lg:grid-cols-[260px_1fr] flex-grow"
    >
      <%- include('./partials/nav.ejs', { activeTab }) %>
      <section class="space-y-6">
        <header>
          <p class="text-xs uppercase tracking-[0.4em] text-slate-400 mb-2">
            ì£¼ë¬¸ ëª©ë¡ / ë°°ì†¡ì¡°íšŒ
          </p>
          <h1 class="text-3xl font-bold">ë‚˜ì˜ ì£¼ë¬¸ í˜„í™©</h1>
          <p class="text-sm text-slate-500 mt-2">
            ìµœê·¼ ì£¼ë¬¸í•œ ìƒí’ˆì˜ ë°°ì†¡ ìƒíƒœë¥¼ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
        </header>

        <!-- í•„í„° ì˜ì—­ -->
        <div class="flex flex-wrap gap-3 mb-6">
          <input
            type="date"
            id="searchStartDate"
            value="<%= filters.startDate %>"
            class="rounded-xl border border-slate-200 px-4 py-2.5 text-sm outline-none focus:border-purple-400"
            onchange="filterOrders()"
          />
          <span class="self-center text-slate-400">~</span>
          <input
            type="date"
            id="searchEndDate"
            value="<%= filters.endDate %>"
            class="rounded-xl border border-slate-200 px-4 py-2.5 text-sm outline-none focus:border-purple-400"
            onchange="filterOrders()"
          />
          <div class="flex-1"></div>
          <div
            class="flex gap-2 rounded-xl border border-slate-200 px-4 py-2.5 text-sm w-full md:w-72 bg-white"
          >
            <input
              type="text"
              id="searchInput"
              value="<%= filters.search %>"
              class="flex-1 focus:outline-none"
              placeholder="ì£¼ë¬¸ë²ˆí˜¸ / ìƒí’ˆëª… ê²€ìƒ‰"
              onkeyup="filterOrders()"
            />
            <span class="text-slate-400 cursor-pointer">âŒ•</span>
          </div>
        </div>

        <!-- ì£¼ë¬¸ ëª©ë¡ -->
        <div class="grid gap-4" id="orderList">
          <% if (mypage.orders && mypage.orders.length > 0) { %> <%
          mypage.orders.forEach((order) => { %>
          <article
            class="order-item rounded-3xl bg-white border border-slate-100 p-6 shadow-sm flex flex-col md:flex-row gap-6 transition hover:shadow-md"
            data-id="<%= order.id %>"
            data-name="<%= order.name %>"
            data-date="<%= order.date %>"
          >
            <!-- ì´ë¯¸ì§€ -->
            <div
              class="w-full md:w-32 h-32 rounded-xl bg-gray-50 border border-slate-100 overflow-hidden flex-shrink-0 flex items-center justify-center"
            >
              <% if (order.cover) { %>
              <img
                src="<%= order.cover %>"
                alt="ëŒ€í‘œ ì´ë¯¸ì§€"
                class="w-full h-full object-contain"
              />
              <% } else { %>
              <span class="text-xs text-slate-300">No Image</span>
              <% } %>
            </div>

            <!-- ì •ë³´ -->
            <div class="flex-1 flex flex-col justify-between">
              <div class="flex items-start justify-between mb-2">
                <div>
                  <div class="flex items-center gap-2 mb-1">
                    <span
                      class="text-xs font-mono text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded"
                      ><%= order.date %></span
                    >
                    <span class="text-xs text-slate-300">|</span>
                    <span class="text-xs font-bold text-slate-500"
                      ><%= order.id %></span
                    >
                  </div>
                  <h3
                    class="text-lg font-bold text-slate-800 line-clamp-2 hover:text-purple-600 transition cursor-pointer"
                  >
                    <%= order.name %>
                  </h3>
                </div>

                <div class="text-right">
                  <% if (order.status === 'ë°°ì†¡ ì¤‘') { %>
                  <span
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-amber-50 text-amber-600 border border-amber-100"
                    >ğŸšš ë°°ì†¡ ì¤‘</span
                  >
                  <% } else if (order.status === 'ë°°ì†¡ ì™„ë£Œ') { %>
                  <span
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-emerald-50 text-emerald-600 border border-emerald-100"
                    >âœ… ë°°ì†¡ ì™„ë£Œ</span
                  >
                  <% } else if (order.status === 'ì£¼ë¬¸ ì·¨ì†Œ') { %>
                  <span
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-gray-100 text-gray-500 border border-gray-200"
                    >ğŸš« ì£¼ë¬¸ ì·¨ì†Œ</span
                  >
                  <% } else { %>
                  <span
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-purple-50 text-purple-600 border border-purple-100"
                    >ğŸ’³ <%= order.status %></span
                  >
                  <% } %>
                </div>
              </div>

              <!-- ë°°ì†¡ì˜ˆì •ì¼ í‘œì‹œ -->
              <div class="text-xs text-slate-500 mb-2">
                <% if (order.status === 'ë°°ì†¡ ì™„ë£Œ') { %>
                <span class="font-bold text-emerald-600">ë°°ì†¡ì™„ë£Œì¼:</span> <%=
                order.eta %> <% } else { %>
                <span class="font-bold">ë°°ì†¡ì˜ˆì •ì¼:</span> <%= order.eta %> <% }
                %>
              </div>

              <div
                class="flex items-end justify-between border-t border-slate-50 pt-3 mt-1"
              >
                <p class="text-xl font-bold text-slate-900">
                  <%= order.price %>ì›
                  <span class="text-sm font-normal text-slate-400">
                    (ì´ <%= order.qty %>ê°œ)</span
                  >
                </p>

                <div class="flex gap-2 items-center">
                  <!-- ê²°ì œ ì™„ë£Œ ìƒíƒœì¼ ë•Œ ì£¼ë¬¸ ì·¨ì†Œ ë²„íŠ¼ í‘œì‹œ -->
                  <% if (order.status === 'ê²°ì œ ì™„ë£Œ') { %>
                  <button
                    onclick="cancelOrder('<%= order.id %>')"
                    class="px-4 py-2 rounded-xl border border-red-200 text-xs font-bold text-red-500 hover:bg-red-50 transition"
                  >
                    ì£¼ë¬¸ ì·¨ì†Œ
                  </button>
                  <% } %>

                  <!-- ìƒì„¸ë³´ê¸° í´ë¦­ -->
                  <button
                    onclick="openOrderDetail('<%= order.id %>', '<%= order.status %>', '<%= order.date %>')"
                    class="px-4 py-2 rounded-xl border border-slate-200 text-sm font-bold text-slate-600 hover:bg-slate-50 transition"
                  >
                    ìƒì„¸ ë³´ê¸°
                  </button>
                </div>
              </div>
            </div>
          </article>
          <% }) %> <% } else { %>
          <div
            class="py-24 text-center bg-white rounded-3xl border border-dashed border-slate-200"
          >
            <span class="text-5xl block mb-3 opacity-30">ğŸ“¦</span>
            <p class="text-slate-500 mb-4">ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            <a
              href="/"
              class="text-purple-600 font-bold hover:underline text-sm"
              >ì‡¼í•‘í•˜ëŸ¬ ê°€ê¸° â†’</a
            >
          </div>
          <% } %>
          <div
            id="noSearchResult"
            class="hidden py-24 text-center text-slate-400"
          >
            <span class="text-4xl block mb-3 opacity-50">ğŸ”</span>
            <p>ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        </div>
      </section>
    </main>

    <!-- ì£¼ë¬¸ ìƒì„¸ ëª¨ë‹¬ -->
    <div
      id="orderModal"
      class="modal fixed inset-0 hidden items-center justify-center z-50"
    >
      <div
        class="modal-overlay absolute inset-0 bg-gray-900 opacity-50"
        onclick="closeOrderModal()"
      ></div>
      <div
        class="bg-white w-11/12 md:max-w-2xl mx-auto rounded-2xl shadow-xl overflow-hidden flex flex-col max-h-[80vh] relative z-50"
      >
        <div
          class="p-5 border-b border-gray-100 flex justify-between items-center bg-slate-50"
        >
          <div>
            <h3 class="text-lg font-bold text-gray-800">ì£¼ë¬¸ ìƒì„¸ ë‚´ì—­</h3>
            <p
              class="text-xs text-slate-500 font-mono mt-0.5"
              id="modalOrderId"
            ></p>
          </div>
          <button
            onclick="closeOrderModal()"
            class="text-gray-400 hover:text-gray-600 p-1"
          >
            âœ•
          </button>
        </div>

        <div class="p-0 overflow-y-auto flex-1 custom-scrollbar">
          <div id="modalItemList" class="divide-y divide-slate-100">
            <!-- JSë¡œ ì•„ì´í…œ ì¶”ê°€ë¨ -->
          </div>
        </div>

        <div
          id="modalFooter"
          class="p-4 border-t border-gray-100 bg-white flex items-center justify-end gap-2"
        >
          <button
            onclick="closeOrderModal()"
            class="px-5 py-2.5 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition text-sm"
          >
            ë‹«ê¸°
          </button>
        </div>
      </div>
    </div>

    <%- include('../partials/footer.ejs') %>

    <script>
      function filterOrders() {
        const searchInput = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const startDateVal = document.getElementById("searchStartDate").value;
        const endDateVal = document.getElementById("searchEndDate").value;

        const items = document.querySelectorAll(".order-item");
        let hasVisibleItem = false;

        items.forEach((item) => {
          const id = item.getAttribute("data-id").toLowerCase();
          const name = item.getAttribute("data-name").toLowerCase();
          const dateStr = item.getAttribute("data-date").replace(/\./g, "-");
          const isSearchMatch =
            id.includes(searchInput) || name.includes(searchInput);
          let isDateMatch = true;
          if (startDateVal && endDateVal) {
            if (dateStr < startDateVal || dateStr > endDateVal)
              isDateMatch = false;
          }

          if (isSearchMatch && isDateMatch) {
            item.classList.remove("hidden");
            hasVisibleItem = true;
          } else {
            item.classList.add("hidden");
          }
        });

        const noResultDiv = document.getElementById("noSearchResult");
        if (items.length > 0) {
          if (!hasVisibleItem) noResultDiv.classList.remove("hidden");
          else noResultDiv.classList.add("hidden");
        }
      }

      async function addToCart(productCode) {
        try {
          const res = await fetch("/cart/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ productCode, qty: 1 }),
          });
          const data = await res.json();
          if (data.success) {
            if (
              confirm("ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤. ì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
            ) {
              location.href = "/cart";
            }
          } else {
            alert(data.message);
          }
        } catch (e) {
          console.error(e);
        }
      }

      // ì£¼ë¬¸ ì·¨ì†Œ í•¨ìˆ˜
      async function cancelOrder(orderId) {
        if (
          !confirm(
            "ì •ë§ ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì·¨ì†Œ í›„ì—ëŠ” ë³µêµ¬ê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."
          )
        )
          return;

        try {
          const res = await fetch("/mypage/orders/cancel", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderId }),
          });
          const data = await res.json();
          if (data.success) {
            alert("ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload();
          } else {
            alert(data.message || "ì£¼ë¬¸ ì·¨ì†Œ ì‹¤íŒ¨");
          }
        } catch (e) {
          console.error(e);
          alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
        }
      }

      async function openOrderDetail(orderId, status, dateStr) {
        try {
          const res = await fetch(`/mypage/orders/detail/${orderId}`);
          const data = await res.json();

          if (data.success) {
            const listContainer = document.getElementById("modalItemList");
            document.getElementById(
              "modalOrderId"
            ).innerText = `ì£¼ë¬¸ë²ˆí˜¸: ${orderId}`;
            listContainer.innerHTML = "";

            const isDelivered =
              status === "ë°°ì†¡ ì™„ë£Œ" || status === "DELIVERED";

            const orderDate = new Date(dateStr.replace(/\./g, "-"));
            const now = new Date();
            const diffTime = Math.abs(now - orderDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const canReturn = isDelivered && diffDays <= 7;

            data.items.forEach((item) => {
              const img = item.image
                ? `<img src="${item.image}" class="w-full h-full object-contain">`
                : `<span class="text-xs text-slate-300">No Image</span>`;

              let buttonsHtml = "";
              if (isDelivered) {
                // [ìˆ˜ì •] ë‹¤ì‹œ ë‹´ê¸° ë²„íŠ¼ì€ í•­ìƒ í‘œì‹œ
                buttonsHtml = `
                    <div class="mt-3 flex gap-2 justify-end pt-3 border-t border-dashed border-slate-100 w-full">
                        <button onclick="addToCart('${item.code}')" class="px-3 py-1.5 rounded-lg border border-slate-200 text-xs font-bold text-slate-600 hover:bg-slate-50 transition">
                            ë‹¤ì‹œ ë‹´ê¸°
                        </button>
                `;

                // [ìˆ˜ì •] ë¦¬ë·°ê°€ ì—†ì„ ë•Œë§Œ ë¦¬ë·° ì“°ê¸° ë²„íŠ¼ í‘œì‹œ
                if (!item.hasReview) {
                  buttonsHtml += `
                        <button onclick="location.href='/mypage/reviews/write?product=${item.code}&order=${orderId}'" class="px-3 py-1.5 rounded-lg bg-purple-50 text-purple-600 text-xs font-bold hover:bg-purple-100 transition">
                            ë¦¬ë·° ì“°ê¸°
                        </button>
                    `;
                }

                buttonsHtml += `</div>`;
              } else {
                buttonsHtml = `
                    <div class="mt-3 flex gap-2 justify-end pt-3 border-t border-dashed border-slate-100 w-full">
                        <button onclick="addToCart('${item.code}')" class="px-3 py-1.5 rounded-lg border border-slate-200 text-xs font-bold text-slate-600 hover:bg-slate-50 transition">
                            ë‹¤ì‹œ ë‹´ê¸°
                        </button>
                    </div>
                  `;
              }

              const html = `
                  <div class="p-5 border-b border-slate-100 last:border-0 hover:bg-slate-50 transition flex flex-col">
                      <div class="flex items-center gap-4">
                          <div class="w-16 h-16 bg-white border border-slate-200 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0">
                              ${img}
                          </div>
                          <div class="flex-1 min-w-0">
                              <p class="text-sm font-bold text-slate-800 truncate">${
                                item.name
                              }</p>
                              <p class="text-xs text-slate-400 mt-1 font-mono">${
                                item.code
                              }</p>
                          </div>
                          <div class="text-right">
                              <p class="text-sm font-bold text-slate-900">${item.price.toLocaleString()}ì›</p>
                              <p class="text-xs text-slate-500 mt-0.5">${
                                item.qty
                              }ê°œ</p>
                          </div>
                      </div>
                      ${buttonsHtml}
                  </div>
              `;
              listContainer.insertAdjacentHTML("beforeend", html);
            });

            const modalFooter = document.getElementById("modalFooter");
            let footerBtns = "";

            // ë°˜í’ˆ/êµí™˜ ì‹ ì²­ë§Œ ë‚¨ê¹€
            if (canReturn) {
              footerBtns += `<button onclick="location.href='/mypage/orders/claim/${orderId}'" class="mr-auto px-4 py-2.5 border border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 transition text-sm">ë°˜í’ˆ/êµí™˜ ì‹ ì²­</button>`;
            }

            footerBtns += `<button onclick="closeOrderModal()" class="px-5 py-2.5 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition text-sm ml-auto">ë‹«ê¸°</button>`;

            modalFooter.innerHTML = footerBtns;

            const modal = document.getElementById("orderModal");
            modal.classList.remove("hidden");
            modal.classList.add("flex");
            document.body.classList.add("modal-active");
          } else {
            alert(data.message || "ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }
        } catch (e) {
          console.error(e);
          alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
        }
      }

      function closeOrderModal() {
        const modal = document.getElementById("orderModal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
        document.body.classList.remove("modal-active");
      }
    </script>
  </body>
</html>
