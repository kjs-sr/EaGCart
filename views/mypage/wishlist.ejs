<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë§ˆì´í˜ì´ì§€ - ì°œ ë¦¬ìŠ¤íŠ¸ | EaGCart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* íˆ´íŒ ì• ë‹ˆë©”ì´ì…˜ */
      @keyframes fadeInOut {
        0% {
          opacity: 0;
          transform: translateY(5px) translateX(-50%);
        }
        10% {
          opacity: 1;
          transform: translateY(0) translateX(-50%);
        }
        90% {
          opacity: 1;
          transform: translateY(0) translateX(-50%);
        }
        100% {
          opacity: 0;
          transform: translateY(-5px) translateX(-50%);
        }
      }
      .tooltip-animate {
        animation: fadeInOut 3s forwards;
      }
    </style>
  </head>
  <body class="bg-slate-50 min-h-screen flex flex-col">
    <%- include('../partials/header.ejs') %>

    <main
      class="max-w-7xl mx-auto w-full px-6 py-12 grid gap-8 lg:grid-cols-[260px_1fr] flex-grow"
    >
      <%- include('./partials/nav.ejs', { activeTab }) %>
      <section class="space-y-6">
        <header>
          <p class="text-xs uppercase tracking-[0.4em] text-slate-400 mb-2">
            ì°œ ë¦¬ìŠ¤íŠ¸
          </p>
          <h1 class="text-3xl font-bold">ì°œí•œ ìƒí’ˆ</h1>
          <p class="text-sm text-slate-500 mt-2">
            ë§ˆìŒì— ë“œëŠ” ìƒí’ˆì„ í•œ ëˆˆì— ë³´ê¸°
          </p>
        </header>

        <!-- ì°œ ëª©ë¡ -->
        <div class="grid gap-4">
          <% if (mypage.wishlist && mypage.wishlist.length > 0) { %> <%
          mypage.wishlist.forEach((item) => { %>
          <article
            class="rounded-3xl bg-white border border-slate-100 p-6 shadow-sm flex flex-wrap items-center gap-6 hover:shadow-md transition duration-200 relative pr-16"
            id="wish-item-<%= item.code %>"
          >
            <!-- ìƒí’ˆ ì´ë¯¸ì§€ -->
            <div
              class="w-24 h-24 bg-gray-50 rounded-xl overflow-hidden border border-slate-100 flex-shrink-0 flex items-center justify-center"
            >
              <% if (item.thumbnail) { %>
              <img
                src="<%= item.thumbnail %>"
                alt="<%= item.name %>"
                class="w-full h-full object-contain"
              />
              <% } else { %>
              <span class="text-xs text-slate-300">No Image</span>
              <% } %>
            </div>

            <div class="flex-1 min-w-0">
              <p
                class="text-xs uppercase tracking-[0.1em] text-slate-400 mb-1 truncate"
              >
                <%= item.console %>
              </p>
              <h3
                class="text-xl font-semibold truncate cursor-pointer hover:text-purple-600"
                onclick="location.href='/product/detail?id=<%= item.code %>'"
              >
                <%= item.name %>
              </h3>
            </div>

            <div class="text-right flex-shrink-0">
              <% if (item.salePrice) { %>
              <div class="flex flex-col items-end">
                <span
                  class="text-xs font-bold text-rose-500 bg-rose-50 px-2 py-0.5 rounded mb-1"
                  >-<%= item.discountRate %>%</span
                >
                <p class="text-2xl font-bold text-rose-600">
                  <%= item.salePrice.toLocaleString() %>ì›
                </p>
                <p class="text-sm text-slate-400 line-through">
                  <%= item.price.toLocaleString() %>ì›
                </p>
              </div>
              <% } else { %>
              <p class="text-2xl font-bold text-slate-900">
                <%= item.price.toLocaleString() %>ì›
              </p>
              <% } %>
            </div>

            <!-- [ìˆ˜ì •] íˆ´íŒ ìœ„ì¹˜ ê¸°ì¤€ì„ ìœ„í•´ relativeì™€ id ì¶”ê°€ -->
            <div
              class="w-full sm:w-auto flex gap-2 relative"
              id="btn-wrapper-<%= item.code %>"
            >
              <button
                onclick="addToCart('<%= item.code %>')"
                class="flex-1 sm:flex-none rounded-xl bg-slate-900 text-white px-5 py-2.5 text-sm font-bold hover:bg-slate-800 transition"
              >
                ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
              </button>
            </div>

            <button
              onclick="removeFromWishlist('<%= item.code %>')"
              class="absolute bottom-6 right-6 text-slate-300 hover:text-rose-500 transition p-2 hover:bg-rose-50 rounded-full"
              title="ëª©ë¡ì—ì„œ ì‚­ì œ"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                />
              </svg>
            </button>
          </article>
          <% }) %> <% } else { %>
          <div
            class="py-20 text-center text-slate-400 bg-white rounded-3xl border border-dashed border-slate-200"
          >
            <span class="text-4xl block mb-2">ğŸ’œ</span>
            <p>ì°œí•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
          <% } %>
        </div>
      </section>
    </main>
    <%- include('../partials/footer.ejs') %>

    <script>
      async function removeFromWishlist(productCode) {
        if (!confirm("ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try {
          const res = await fetch("/product/wishlist/toggle", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ productCode }),
          });
          const data = await res.json();
          if (data.success && data.action === "removed") {
            document.getElementById(`wish-item-${productCode}`).remove();
            if (document.querySelectorAll("article").length === 0)
              location.reload();
          } else {
            alert("ì‚­ì œ ì‹¤íŒ¨");
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function addToCart(productCode) {
        try {
          const res = await fetch("/cart/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ productCode, qty: 1 }),
          });
          const data = await res.json();

          if (data.success) {
            // [ìˆ˜ì •] ì•Œë¦¼ì°½ ì œê±°í•˜ê³  íˆ´íŒ í‘œì‹œ
            showTooltip(productCode);
          } else {
            // ë¡œê·¸ì¸ í•„ìš” ë“± ë‹¤ë¥¸ ë©”ì‹œì§€ëŠ” ì•Œë¦¼ì°½ ìœ ì§€
            if (data.needLogin) {
              if (
                confirm(
                  "ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
                )
              )
                location.href = "/login";
            } else {
              alert(data.message);
            }
          }
        } catch (e) {
          console.error(e);
        }
      }

      // [ì‹ ê·œ] íˆ´íŒ í‘œì‹œ í•¨ìˆ˜
      function showTooltip(code) {
        const wrapper = document.getElementById(`btn-wrapper-${code}`);

        // ê¸°ì¡´ íˆ´íŒ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        const oldTooltip = wrapper.querySelector(".cart-tooltip");
        if (oldTooltip) oldTooltip.remove();

        const tooltip = document.createElement("div");
        // bottom-full, left-1/2, -translate-x-1/2ë¥¼ ì‚¬ìš©í•˜ì—¬ ë²„íŠ¼ ì¤‘ì•™ ìƒë‹¨ì— ë°°ì¹˜
        tooltip.className =
          "cart-tooltip absolute bottom-full left-1/2 -translate-x-1/2 mb-3 bg-gray-900 text-white text-xs py-2 px-4 rounded-full shadow-xl flex items-center gap-2 z-50 whitespace-nowrap tooltip-animate";
        tooltip.innerHTML = `
          <span>âœ… ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤</span>
          <a href="/cart" class="text-purple-300 hover:text-white font-bold underline">ì´ë™</a>
          <div class="absolute bottom-[-4px] left-1/2 -translate-x-1/2 w-2 h-2 bg-gray-900 rotate-45"></div>
        `;

        wrapper.appendChild(tooltip);

        // 3ì´ˆ í›„ ì œê±°
        setTimeout(() => {
          tooltip.remove();
        }, 3000);
      }
    </script>
  </body>
</html>
